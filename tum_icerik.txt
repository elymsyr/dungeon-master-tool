--------------------------------------------------
Path: README.md
--------------------------------------------------
# üêâ Dungeon Master Tool

**Dungeon Master Tool** is a powerful, offline-first desktop application designed to assist Dungeon Masters in running D&D 5e campaigns seamlessly. Built with Python and PyQt6, it combines campaign management, API integration, combat tracking, and a **virtual tabletop (VTT)** experience into a single, portable executable.

![Status](https://img.shields.io/badge/Status-Stable-green) ![License](https://img.shields.io/badge/License-MIT-blue) ![Python](https://img.shields.io/badge/Python-3.x-yellow)

## ‚ú® Key Features

### üó∫Ô∏è Battle Map & Virtual Tabletop (New!)
- **Interactive Battle Map Window**: Open a dedicated map window that syncs with the Combat Tracker.
- **Token System**: 
    - Automatically generates tokens for every combatant (Players, NPCs, Monsters).
    - **Drag & Drop**: Move tokens freely around the map.
    - **visual Styles**: Tokens indicate allegiance (Green for Players, Red for Enemies) and highlight the current turn.
    - **Resizable Tokens**: Adjust token sizes dynamically using a slider (Tiny to Gargantuan).
- **Map Selector**: Visual gallery to quickly select previously imported maps or load new ones.
- **State Persistence**: The app remembers the exact position of every token and the active map even after closing and reopening the application.

### ‚öîÔ∏è Advanced Combat Tracker & Session
- **Auto-Save & Resume**: Never lose progress. Sessions, combat states, HP, initiative orders, and map positions are saved automatically. Close the app and resume exactly where you left off.
- **Initiative System**: 
    - Auto-roll initiative with DEX modifiers.
    - Support for manual entry and custom bonuses.
    - Visual indicators for the current turn.
- **Quick Add**: Rapidly add ad-hoc combatants (e.g., "Goblin #3") without clogging your database.
- **Condition Manager**: Right-click to apply status effects (Blinded, Stunned, etc.) with visual cues.
- **Event Logging**: Chronological log of events and dice rolls.

### üìö Database & Campaign Management
- **Smart API Import**: 
    - Browse and import Monsters, Spells, and Items from the D&D 5e SRD API.
    - **Deep Import**: When importing a monster (e.g., *Lich*), the tool automatically detects and downloads all its linked spells into your database.
- **Navigation History**: "Back" and "Forward" buttons to navigate between entity cards like a web browser.
- **Offline Storage**: Create and manage multiple worlds/campaigns locally.
- **Entity Management**: Create NPCs, Monsters, Locations, Quests, and Lore.
- **Extended Stats**: Support for Saving Throws, Skills, Resistances, Immunities, and Legendary Actions.
- **Lore & Docs**: Attach and view **PDF** files directly within the app.
- **Export**: Export your entire database to a readable `.txt` file.

### üì∫ Player Facing View (Second Screen)
- **Second Screen Support**: Open a dedicated "Player Window" on a secondary monitor/projector.
- **Map Projection**: Project the Battle Map to players. They see the map and tokens, but **Monster HP is hidden** (shown as `???`).
- **Stat Block Projection**: Show formatted stat blocks or images of NPCs/Monsters to players with a single click.
- **PDF & Image Sharing**: Instantly project handouts, letters, or scene visuals.

---

## üöÄ Installation & Usage

### Option 1: Portable Executable (Recommended)
This tool is fully portable.
1. Download or locate `DungeonMasterTool.exe`.
2. Place it on your PC or a **USB Drive**.
3. Run it!
   - **Data Storage**: All your worlds, images, PDFs, and logs are saved in the **same directory** (or parent directory) of the executable.

### Option 2: Running from Source
1. **Clone the repository**:
   ```bash
   git clone https://github.com/yourusername/dungeon-master-tool.git
   cd dungeon-master-tool
   ```

2. **Install Dependencies**:
   ```bash
   pip install -r requirements.txt
   ```
   *Dependencies: `PyQt6`, `requests`, `PyQt6-WebEngine`*

3. **Run the App**:
   ```bash
   python main.py
   ```

---

## üéÆ How to Use

### 1. Creating a World
On first launch, select "Yeni D√ºnya Olu≈ütur" (Create New World).

### 2. Database & API
- Go to the **Veritabanƒ±** (Database) tab.
- Click **"API Tarayƒ±cƒ±"**, search for "Adult Red Dragon", and click **Import**.
- The tool will download the dragon AND its specific actions/traits automatically.
- Double-click spells in the monster's sheet to view their details.

### 3. Running Combat & Maps
- Switch to the **Oturum** (Session) tab.
- Add combatants (Players or Monsters from DB).
- Click **"üó∫Ô∏è Battle Map"**.
- Select a map image.
- A new window opens with tokens for all combatants.
- **Drag tokens** to position them.
- Use **"Next Turn"** in the main window; the Battle Map updates automatically to highlight the active character.

### 4. Player Screen
- Click **"üì∫ Oyuncu Ekranƒ±nƒ± A√ß/Kapat"** in the top toolbar.
- Drag the black window to your second monitor.
- Use **"üëÅÔ∏è Oyuncuya G√∂ster"** buttons on images or the "Project Map" button to share visuals.

---

## üìÇ Project Structure

```
dungeon-master-tool/
‚îú‚îÄ‚îÄ core/               # Business logic (API, DataManager, Models)
‚îú‚îÄ‚îÄ ui/                 # UI Components
‚îÇ   ‚îú‚îÄ‚îÄ dialogs/        # Popups (API Browser, Map Selector)
‚îÇ   ‚îú‚îÄ‚îÄ tabs/           # Main Tabs (Database, Map, Session)
‚îÇ   ‚îú‚îÄ‚îÄ widgets/        # Reusable widgets (Combat Tracker, Sheet)
‚îÇ   ‚îî‚îÄ‚îÄ windows/        # Separate windows (Player View, Battle Map)
‚îú‚îÄ‚îÄ assets/             # Static assets
‚îú‚îÄ‚îÄ main.py             # Entry Point
‚îú‚îÄ‚îÄ config.py           # Configuration
‚îî‚îÄ‚îÄ README.md           # This file
```

## ü§ù Credits
- **Framework**: [PyQt6](https://pypi.org/project/PyQt6/)
- **Data Source**: [D&D 5e API](https://www.dnd5eapi.co/)

--------------------------------------------------
Path: .gitattributes
--------------------------------------------------
*.exe filter=lfs diff=lfs merge=lfs -text


--------------------------------------------------
Path: main.py
--------------------------------------------------
import sys
from PyQt6.QtWidgets import (QApplication, QMainWindow, QTabWidget, QVBoxLayout, 
                             QWidget, QMessageBox, QFileDialog, QHBoxLayout, 
                             QPushButton, QLabel)
from config import STYLESHEET
from core.data_manager import DataManager
from ui.player_window import PlayerWindow
from ui.tabs.database_tab import DatabaseTab
from ui.tabs.map_tab import MapTab
from ui.tabs.session_tab import SessionTab # <--- YENƒ∞ EKLENEN IMPORT
from ui.campaign_selector import CampaignSelector
from core.locales import tr

class MainWindow(QMainWindow):
    def __init__(self, data_manager):
        super().__init__()
        self.data_manager = data_manager
        self.player_window = PlayerWindow()
        
        self.setWindowTitle(f"DM Tool - {self.data_manager.data.get('world_name', 'Bilinmiyor')}")
        self.setGeometry(100, 100, 1400, 900)
        self.setStyleSheet(STYLESHEET)
        
        self.init_ui()

    def init_ui(self):
        central = QWidget()
        self.setCentralWidget(central)
        main_layout = QVBoxLayout(central)
        
        # --- √úST BAR (TOOLBAR) ---
        toolbar = QHBoxLayout()
        
        
        # Oyuncu Ekranƒ± Butonu
        self.btn_toggle_player = QPushButton(tr("BTN_PLAYER_SCREEN"))
        self.btn_toggle_player.setCheckable(True)
        self.btn_toggle_player.setStyleSheet("""
            QPushButton { background-color: #6a1b9a; color: white; font-weight: bold; padding: 8px; }
            QPushButton:checked { background-color: #4a148c; border: 2px solid #ea80fc; }
        """)
        self.btn_toggle_player.clicked.connect(self.toggle_player_window)
        
        # Dƒ±≈üa Aktar Butonu
        self.btn_export_txt = QPushButton(tr("BTN_EXPORT"))
        self.btn_export_txt.setStyleSheet("background-color: #00796b; color: white; font-weight: bold; padding: 8px;")
        self.btn_export_txt.clicked.connect(self.export_entities_to_txt)
        
        # D√ºnya Bilgisi
        self.lbl_campaign = QLabel(f"{tr('LBL_CAMPAIGN')} {self.data_manager.data.get('world_name')}")
        self.lbl_campaign.setStyleSheet("color: #888; font-style: italic; margin-left: 10px;")

        toolbar.addWidget(self.btn_toggle_player)
        toolbar.addWidget(self.btn_export_txt)
        toolbar.addWidget(self.lbl_campaign)
        toolbar.addStretch()
        
        main_layout.addLayout(toolbar)
        
        # --- SEKMELER (TABS) ---
        self.tabs = QTabWidget()
        
        # Tab 1: Veritabanƒ±
        self.db_tab = DatabaseTab(self.data_manager, self.player_window)
        self.tabs.addTab(self.db_tab, tr("TAB_DB"))
        
        # Tab 2: Harita
        # self'i (MainWindow) g√∂nderiyoruz ki pinlere tƒ±klayƒ±nca db_tab'a ge√ßebilsin
        self.map_tab = MapTab(self.data_manager, self.player_window, self) 
        self.tabs.addTab(self.map_tab, tr("TAB_MAP")) 
        
        # Tab 3: Session (Oyun Y√∂netimi)
        self.session_tab = SessionTab(self.data_manager)
        self.tabs.addTab(self.session_tab, tr("TAB_SESSION"))
        
        main_layout.addWidget(self.tabs)
        
        # Ba≈ülangƒ±√ßta haritayƒ± y√ºkle (varsa)
        self.map_tab.render_map()

    def toggle_player_window(self):
        if self.player_window.isVisible():
            self.player_window.hide()
            self.btn_toggle_player.setChecked(False)
        else:
            self.player_window.show()
            self.btn_toggle_player.setChecked(True)

    def export_entities_to_txt(self):
        # Kayƒ±t yeri sor
        path, _ = QFileDialog.getSaveFileName(self, "Listeyi Kaydet", "export.txt", "Text Files (*.txt)")
        if not path: return
        
        try:
            with open(path, "w", encoding="utf-8") as f:
                f.write(f"ZINDAN EFENDISI - VARLIK LISTESI\n")
                f.write(f"D√ºnya: {self.data_manager.data.get('world_name')}\n")
                f.write("="*50 + "\n\n")
                
                entities = self.data_manager.data.get("entities", {})
                if not entities:
                    f.write("Hen√ºz kaydedilmi≈ü varlƒ±k yok.\n")
                
                # Sƒ±ralayarak yazalƒ±m
                sorted_keys = sorted(entities.keys(), key=lambda k: entities[k].get("name", ""))
                
                for i, eid in enumerate(sorted_keys, 1):
                    ent = entities[eid]
                    name = ent.get("name", "ƒ∞simsiz")
                    type_ = ent.get("type", "Bilinmiyor")
                    tags = ", ".join(ent.get("tags", []))
                    desc = ent.get("description", "").replace("\n", " ")
                    if len(desc) > 100: desc = desc[:97] + "..."
                    
                    f.write(f"{i}. {name} ({type_})\n")
                    if tags: f.write(f"   Etiketler: {tags}\n")
                    f.write(f"   A√ßƒ±klama: {desc}\n")
                    
                    # Statlarƒ± da ekleyelim (Sadece sava≈ü√ßƒ± varlƒ±klar i√ßin)
                    c = ent.get("combat_stats", {})
                    # Sadece belirli tiplerde statlarƒ± g√∂sterelim
                    if type_ in ["NPC", "Canavar", "Oyuncu"] and c:
                        hp = c.get("hp", "-")
                        ac = c.get("ac", "-")
                        cr = c.get("cr", "-")
                        f.write(f"   HP: {hp} | AC: {ac} | CR: {cr}\n")
                        
                    f.write("-" * 30 + "\n")
            
            QMessageBox.information(self, "Ba≈üarƒ±lƒ±", "Liste ba≈üarƒ±yla dƒ±≈üa aktarƒ±ldƒ±.")
        except Exception as e:
            QMessageBox.critical(self, "Hata", f"Dosya yazƒ±lamadƒ±:\n{e}")


if __name__ == "__main__":
    app = QApplication(sys.argv)
    
    # 1. Veri Y√∂neticisi Ba≈ülat
    dm = DataManager()
    
    # 2. Se√ßim Ekranƒ±
    selector = CampaignSelector(dm)
    if selector.exec():
        # 3. Ana Pencere
        window = MainWindow(dm)
        window.show()
        sys.exit(app.exec())
    else:
        sys.exit()

--------------------------------------------------
Path: build_exe.py
--------------------------------------------------
import PyInstaller.__main__
import os
import shutil

# Temizlik
if os.path.exists("dist"): shutil.rmtree("dist")
if os.path.exists("build"): shutil.rmtree("build")

# PyInstaller parametreleri
params = [
    'main.py',
    '--name=DungeonMasterTool',
    '--onefile',
    '--noconsole',
    '--clean',
    # '--icon=assets/icon.ico', # Icon dosyasƒ± varsa a√ßƒ±n
    # Gerekli importlar (bazen otomatik algƒ±lamaz)
    '--hidden-import=PyQt6',
    '--hidden-import=requests',
    '--hidden-import=PyQt6.QtWebEngineWidgets', # PDF Projection support
    
    # Data dosyalarƒ±: (src, dest)
    # config.py, core vs kodun i√ßine g√∂m√ºl√ºr.
    # Ancak eƒüer asset, icon vs varsa buraya eklenmeli.
    # ≈ûu anlƒ±k ekstra asset dosyamƒ±z proje k√∂k√ºnde yok gibi (assets klas√∂r√º user docs'ta olacak).
    # Eƒüer proje i√ßinde daƒüƒ±tƒ±lmasƒ± gereken sabit data (√∂rn default icons) olsaydƒ±:
    # '--add-data=assets;assets',
]

print("EXE Hazirlaniyor...")
PyInstaller.__main__.run(params)
print("Islem Tamamlandi! 'dist' klasorunu kontrol edin.")


--------------------------------------------------
Path: config.py
--------------------------------------------------
import os

import os
import sys

def get_base_path():
    """ PyInstaller ile uyumlu base path d√∂ner. """
    if getattr(sys, 'frozen', False):
        return sys._MEIPASS
    return os.path.dirname(os.path.abspath(__file__))

BASE_DIR = get_base_path()

BASE_DIR = get_base_path()

def get_data_root():
    """ 
    Verilerin saklanacaƒüƒ± dizin.
    User isteƒüi: 'exe dosyasƒ±nƒ±n bir √ºst dizininde tutsun'
    """
    if getattr(sys, 'frozen', False):
        # Frozen (EXE): sys.executable -> .../dist/Game.exe
        # dirname -> .../dist
        # dirname(dirname) -> .../ (Proje k√∂k√º veya exe'nin √ºst klas√∂r√º)
        exe_path = sys.executable
        return os.path.dirname(os.path.dirname(exe_path))
    else:
        # Dev: .../root/config.py -> .../root
        return os.path.dirname(os.path.abspath(__file__))

DATA_ROOT = get_data_root()

WORLDS_DIR = os.path.join(DATA_ROOT, "worlds")
CACHE_DIR = os.path.join(DATA_ROOT, "cache")
IMAGES_DIR = os.path.join(DATA_ROOT, "assets")

# Klas√∂rleri olu≈ütur
for d in [WORLDS_DIR, CACHE_DIR, IMAGES_DIR]:
    if not os.path.exists(d):
        os.makedirs(d)

API_BASE_URL = "https://www.dnd5eapi.co/api"

# --- EPƒ∞K TEMA ---
STYLESHEET = """
/* GENEL AYARLAR */
QMainWindow, QDialog {
    background-color: #121212;
    color: #e0e0e0;
}
QWidget {
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
    color: #eeeeee;
}

/* GRUPLAR VE PANELLER */
QGroupBox {
    border: 1px solid #333;
    border-radius: 8px;
    margin-top: 22px;
    background-color: #1e1e1e;
    font-weight: bold;
}
QGroupBox::title {
    subcontrol-origin: margin;
    subcontrol-position: top left;
    padding: 0 5px;
    color: #ffb74d; /* Altƒ±n Sarƒ±sƒ± */
    background-color: #121212;
}

/* Lƒ∞STELER */
QListWidget {
    background-color: #1e1e1e;
    border: 1px solid #333;
    border-radius: 6px;
    outline: none;
}
QListWidget::item {
    padding: 8px;
    border-bottom: 1px solid #2c2c2c;
    color: #ccc;
}
QListWidget::item:selected {
    background: qlineargradient(x1:0, y1:0, x2:1, y2:0, stop:0 #311b92, stop:1 #4527a0); /* Mor Gradyan */
    color: white;
    border-left: 4px solid #ffb74d;
}
QListWidget::item:hover {
    background-color: #252525;
}

/* INPUTLAR */
QLineEdit, QTextEdit, QComboBox {
    background-color: #252525;
    border: 1px solid #444;
    border-radius: 4px;
    padding: 6px;
    color: #fff;
    selection-background-color: #7c4dff;
}
QLineEdit:focus, QTextEdit:focus, QComboBox:focus {
    border: 1px solid #7c4dff; /* Parlak Mor */
}

/* BUTONLAR - GENEL */
QPushButton {
    background-color: #333;
    border: 1px solid #444;
    border-radius: 4px;
    padding: 8px 16px;
    font-weight: bold;
    color: #ddd;
}
QPushButton:hover {
    background-color: #444;
    border-color: #666;
}
QPushButton:pressed {
    background-color: #222;
}

/* √ñZEL BUTONLAR */
QPushButton#primaryBtn {
    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #1565c0, stop:1 #0d47a1);
    border: 1px solid #0d47a1;
    color: white;
}
QPushButton#primaryBtn:hover { background: #1976d2; }

QPushButton#dangerBtn {
    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #c62828, stop:1 #b71c1c);
    border: 1px solid #b71c1c;
    color: white;
}
QPushButton#dangerBtn:hover { background: #d32f2f; }

QPushButton#successBtn {
    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #2e7d32, stop:1 #1b5e20);
    border: 1px solid #1b5e20;
    color: white;
}
QPushButton#successBtn:hover { background: #388e3c; }

/* SEKMELER (TABS) */
QTabWidget::pane {
    border: 1px solid #333;
    background-color: #121212;
    top: -1px;
}
QTabBar::tab {
    background: #1e1e1e;
    color: #888;
    padding: 10px 25px;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
    margin-right: 2px;
    font-weight: bold;
}
QTabBar::tab:selected {
    background: #252525;
    color: #ffb74d;
    border-top: 3px solid #ffb74d;
}
QTabBar::tab:hover {
    background: #333;
    color: #ccc;
}

/* SCROLLBAR (Modern ƒ∞nce √áubuk) */
QScrollBar:vertical {
    border: none;
    background: #121212;
    width: 10px;
    margin: 0px 0px 0px 0px;
}
QScrollBar::handle:vertical {
    background: #444;
    min-height: 20px;
    border-radius: 5px;
}
QScrollBar::handle:vertical:hover {
    background: #666;
}
QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {
    height: 0px;
}
"""

--------------------------------------------------
Path: .gitignore
--------------------------------------------------
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[codz]
*$py.class
worlds/

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.nox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.py.cover
.hypothesis/
.pytest_cache/
cover/

# Translations
*.mo
*.pot

# Django stuff:
*.log
local_settings.py
db.sqlite3
db.sqlite3-journal

# Flask stuff:
instance/
.webassets-cache

# Scrapy stuff:
.scrapy

# Sphinx documentation
docs/_build/

# PyBuilder
.pybuilder/
target/

# Jupyter Notebook
.ipynb_checkpoints

# IPython
profile_default/
ipython_config.py

# pyenv
#   For a library or package, you might want to ignore these files since the code is
#   intended to run in multiple environments; otherwise, check them in:
# .python-version

# pipenv
#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.
#   However, in case of collaboration, if having platform-specific dependencies or dependencies
#   having no cross-platform support, pipenv may install dependencies that don't work, or not
#   install all needed dependencies.
#Pipfile.lock

# UV
#   Similar to Pipfile.lock, it is generally recommended to include uv.lock in version control.
#   This is especially recommended for binary packages to ensure reproducibility, and is more
#   commonly ignored for libraries.
#uv.lock

# poetry
#   Similar to Pipfile.lock, it is generally recommended to include poetry.lock in version control.
#   This is especially recommended for binary packages to ensure reproducibility, and is more
#   commonly ignored for libraries.
#   https://python-poetry.org/docs/basic-usage/#commit-your-poetrylock-file-to-version-control
#poetry.lock
#poetry.toml

# pdm
#   Similar to Pipfile.lock, it is generally recommended to include pdm.lock in version control.
#   pdm recommends including project-wide configuration in pdm.toml, but excluding .pdm-python.
#   https://pdm-project.org/en/latest/usage/project/#working-with-version-control
#pdm.lock
#pdm.toml
.pdm-python
.pdm-build/

# pixi
#   Similar to Pipfile.lock, it is generally recommended to include pixi.lock in version control.
#pixi.lock
#   Pixi creates a virtual environment in the .pixi directory, just like venv module creates one
#   in the .venv directory. It is recommended not to include this directory in version control.
.pixi

# PEP 582; used by e.g. github.com/David-OConnor/pyflow and github.com/pdm-project/pdm
__pypackages__/

# Celery stuff
celerybeat-schedule
celerybeat.pid

# SageMath parsed files
*.sage.py

# Environments
.env
.envrc
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# Pyre type checker
.pyre/

# pytype static type analyzer
.pytype/

# Cython debug symbols
cython_debug/

# PyCharm
#  JetBrains specific template is maintained in a separate JetBrains.gitignore that can
#  be found at https://github.com/github/gitignore/blob/main/Global/JetBrains.gitignore
#  and can be added to the global gitignore or merged into this file.  For a more nuclear
#  option (not recommended) you can uncomment the following to ignore the entire idea folder.
#.idea/

# Abstra
# Abstra is an AI-powered process automation framework.
# Ignore directories containing user credentials, local state, and settings.
# Learn more at https://abstra.io/docs
.abstra/

# Visual Studio Code
#  Visual Studio Code specific template is maintained in a separate VisualStudioCode.gitignore 
#  that can be found at https://github.com/github/gitignore/blob/main/Global/VisualStudioCode.gitignore
#  and can be added to the global gitignore or merged into this file. However, if you prefer, 
#  you could uncomment the following to ignore the entire vscode folder
# .vscode/

# Ruff stuff:
.ruff_cache/

# PyPI configuration file
.pypirc

# Cursor
#  Cursor is an AI-powered code editor. `.cursorignore` specifies files/directories to
#  exclude from AI features like autocomplete and code analysis. Recommended for sensitive data
#  refer to https://docs.cursor.com/context/ignore-files
.cursorignore
.cursorindexingignore

# Marimo
marimo/_static/
marimo/_lsp/
__marimo__/


--------------------------------------------------
Path: requirements.txt
--------------------------------------------------
PyQt6
requests

--------------------------------------------------
Path: core/api_client.py
--------------------------------------------------
import requests
from config import API_BASE_URL

class DndApiClient:
    def __init__(self):
        self.session = requests.Session()
        self.ENDPOINT_MAP = {
            "Canavar": "monsters",
            "B√ºy√º (Spell)": "spells",
            "E≈üya (Equipment)": "equipment",
            "Sƒ±nƒ±f (Class)": "classes",
            "Irk (Race)": "races",
            "Magic Item": "magic-items"
        }

    # ... (get_list, search, _fetch_all aynƒ± kalƒ±yor) ...
    def get_list(self, category):
        endpoint = self.ENDPOINT_MAP.get(category)
        if not endpoint:
            if category == "E≈üya (Equipment)":
                l1 = self._fetch_all("equipment")
                l2 = self._fetch_all("magic-items")
                return l1 + l2
            return []
        return self._fetch_all(endpoint)

    def _fetch_all(self, endpoint):
        url = f"{API_BASE_URL}/{endpoint}"
        try:
            response = self.session.get(url, timeout=10)
            if response.status_code == 200:
                return response.json().get("results", [])
            return []
        except Exception:
            return []

    def search(self, category, query):
        endpoint = self.ENDPOINT_MAP.get(category)
        if not endpoint: return None, "Kategori desteklenmiyor."

        formatted_query = query.lower().strip().replace(" ", "-")
        url = f"{API_BASE_URL}/{endpoint}/{formatted_query}"
        
        try:
            response = self.session.get(url, timeout=10)
            if response.status_code == 200:
                return self.parse_dispatcher(category, response.json()), "Ba≈üarƒ±lƒ±"
            
            if category == "E≈üya (Equipment)":
                url2 = f"{API_BASE_URL}/magic-items/{formatted_query}"
                resp2 = self.session.get(url2, timeout=10)
                if resp2.status_code == 200:
                    return self.parse_equipment(resp2.json()), "Magic Item bulundu."

            return None, "Bulunamadƒ±."
        except Exception as e:
            return None, str(e)

    def parse_dispatcher(self, category, data):
        if category == "Canavar": return self.parse_monster(data)
        elif category == "B√ºy√º (Spell)": return self.parse_spell(data)
        elif category == "E≈üya (Equipment)": return self.parse_equipment(data)
        elif category == "Sƒ±nƒ±f (Class)": return self.parse_class(data)
        elif category == "Irk (Race)": return self.parse_race(data)
        return {}

    def parse_monster(self, data):
        """
        API'den gelen ham canavar verisini uygulamanƒ±n veri yapƒ±sƒ±na √ßevirir.
        Ayrƒ±ca 'spellcasting' √∂zelliƒüi varsa b√ºy√ºlerin indexlerini yakalar.
        """
        # 1. AC Parse (Zƒ±rh Sƒ±nƒ±fƒ±)
        ac_val = "10"
        raw_ac = data.get("armor_class", [])
        if isinstance(raw_ac, list) and len(raw_ac) > 0:
            ac_entry = raw_ac[0]
            ac_val = f"{ac_entry.get('value', 10)}"
            if ac_entry.get('type'): 
                ac_val += f" ({ac_entry.get('type')})"
        else:
            ac_val = str(data.get("armor_class", 10))

        # 2. Hƒ±z Parse
        speed_dict = data.get("speed", {})
        speed_str = ", ".join([f"{k.capitalize()} {v}" for k, v in speed_dict.items()])

        # 3. Saves & Skills Parse (Proficiencies listesinden ayƒ±klama)
        saves = []
        skills = []
        for prof in data.get("proficiencies", []):
            name = prof.get("proficiency", {}).get("name", "")
            val = prof.get("value", 0)
            sign = "+" if val >= 0 else ""
            
            if "Saving Throw:" in name:
                # √ñrn: "Saving Throw: DEX" -> "DEX +5"
                stat = name.replace("Saving Throw:", "").strip()
                saves.append(f"{stat} {sign}{val}")
            elif "Skill:" in name:
                # √ñrn: "Skill: Perception" -> "Perception +6"
                skill_name = name.replace("Skill:", "").strip()
                skills.append(f"{skill_name} {sign}{val}")

        # 4. Action/Trait Formatlama Yardƒ±mcƒ±sƒ±
        def format_actions(action_list):
            formatted = []
            for action in action_list:
                name = action.get("name", "Action")
                desc = action.get("desc", "")
                # API bazen 'attack_bonus' veya 'damage' verir ama bunlar genellikle 'desc' metninde yazƒ±lƒ±dƒ±r.
                # Biz sadece temiz name/desc ikilisini alƒ±yoruz.
                formatted.append({"name": name, "desc": desc})
            return formatted

        # 5. B√úY√ú TESPƒ∞Tƒ∞ (Spellcasting Detection)
        detected_spells = []
        # special_abilities i√ßinde 'spellcasting' anahtarƒ± olan bir yetenek arƒ±yoruz
        for ability in data.get("special_abilities", []):
            if "spellcasting" in ability:
                # ability["spellcasting"]["spells"] -> [{"name": "Fireball", "url": ".../fireball"}]
                spells_list = ability["spellcasting"].get("spells", [])
                for spell_ref in spells_list:
                    url = spell_ref.get("url")
                    if url:
                        # URL sonundaki index'i al (√∂rn: "fireball")
                        index = url.rstrip("/").split("/")[-1]
                        detected_spells.append(index)

        # 6. Veri S√∂zl√ºƒü√ºn√º Olu≈ütur
        return {
            "name": data.get("name"),
            "type": "Canavar",
            "description": f"Size: {data.get('size')}, Type: {data.get('type')}, Alignment: {data.get('alignment')}",
            "tags": [data.get("type", ""), data.get("size", "")],
            "image_path": "", # API resimleri online URL'dir, lokalde yoksa bo≈ü bƒ±rakƒ±yoruz

            # Temel Statlar
            "stats": {
                "STR": data.get("strength", 10),
                "DEX": data.get("dexterity", 10),
                "CON": data.get("constitution", 10),
                "INT": data.get("intelligence", 10),
                "WIS": data.get("wisdom", 10),
                "CHA": data.get("charisma", 10)
            },
            
            # Sava≈ü Statlarƒ±
            "combat_stats": {
                "hp": str(data.get("hit_points", 10)),
                "max_hp": f"{data.get('hit_points', 10)} ({data.get('hit_dice', '')})",
                "ac": str(ac_val),
                "speed": speed_str,
                "cr": str(data.get("challenge_rating", 0)),
                "xp": str(data.get("xp", 0)),
                "initiative": "" # Genelde DEX'ten hesaplanƒ±r, bo≈ü bƒ±rakƒ±yoruz
            },

            # Geli≈ümi≈ü Statlar
            "saving_throws": ", ".join(saves),
            "skills": ", ".join(skills),
            "damage_vulnerabilities": ", ".join(data.get("damage_vulnerabilities", [])),
            "damage_resistances": ", ".join(data.get("damage_resistances", [])),
            "damage_immunities": ", ".join(data.get("damage_immunities", [])),
            "condition_immunities": ", ".join([c["name"] if isinstance(c, dict) else c for c in data.get("condition_immunities", [])]),
            "proficiency_bonus": str(data.get("proficiency_bonus", "")),
            "passive_perception": str(data.get("senses", {}).get("passive_perception", "")),

            # Listeler
            "traits": format_actions(data.get("special_abilities", [])),
            "actions": format_actions(data.get("actions", [])),
            "reactions": format_actions(data.get("reactions", [])),
            "legendary_actions": format_actions(data.get("legendary_actions", [])),
            
            # Ek √ñzellikler
            "attributes": {
                "Duyular (Senses)": ", ".join([f"{k}: {v}" for k, v in data.get("senses", {}).items() if k != "passive_perception"]),
                "Diller": data.get("languages", "-")
            },

            # GE√áƒ∞Cƒ∞ ALAN (DataManager bunu okuyup silecek)
            "_detected_spell_indices": detected_spells
        }

    def parse_spell(self, data):
        desc = "\n".join(data.get("desc", []))
        if data.get("higher_level"):
            desc += "\n\n**Higher Levels:** " + "\n".join(data.get("higher_level", []))
        
        # Components
        comps = data.get("components", [])
        comp_str = ", ".join(comps)
        if "M" in comps and data.get("material"):
            comp_str += f" ({data.get('material')})"

        # Damage
        dmg_str = ""
        dmg = data.get("damage", {})
        if dmg.get("damage_type"):
            dmg_str = f"Type: {dmg['damage_type'].get('name')}"
        
        if dmg.get("damage_at_slot_level"):
            levels = [f"Lvl {k}: {v}" for k,v in dmg["damage_at_slot_level"].items()]
            # √áok uzun olmasƒ±n diye ilk ve sonu alalƒ±m veya yan yana yazalƒ±m
            dmg_str += " | " + ", ".join(levels[:3]) + ("..." if len(levels)>3 else "")

        classes = [c["name"] for c in data.get("classes", [])]
        
        return {
            "name": data.get("name"),
            "type": "B√ºy√º (Spell)",
            "description": desc,
            "tags": classes + [f"Level {data.get('level')}", data.get("school", {}).get("name", "")],
            "attributes": {
                "Seviye": str(data.get("level")),
                "Okul": data.get("school", {}).get("name", ""),
                "S√ºre (Casting Time)": data.get("casting_time", ""),
                "Menzil (Range)": data.get("range", ""),
                "Bile≈üenler": comp_str,
                "S√ºreklilik (Duration)": ("Concentration, " if data.get("concentration") else "") + data.get("duration", ""),
                "Rit√ºel": "Evet" if data.get("ritual") else "Hayƒ±r",
                "Hasar": dmg_str
            }
        }

    def parse_equipment(self, data):
        desc = "\n".join(data.get("desc", []))
        
        # Maliyet parse
        cost = data.get("cost", {})
        cost_str = f"{cost.get('quantity', 0)} {cost.get('unit', '')}"
        
        # Hasar parse (Silahsa)
        dmg_str = ""
        if data.get("damage"):
            dmg_str = f"{data['damage']['damage_dice']} {data['damage']['damage_type']['name']}"
            
        # Zƒ±rh parse
        ac_str = ""
        if data.get("armor_class"):
            ac = data["armor_class"]
            ac_str = str(ac.get("base", 10))
            if ac.get("dex_bonus"): ac_str += " + Dex"
            
        return {
            "name": data.get("name"),
            "type": "E≈üya (Equipment)",
            "description": desc,
            "tags": [data.get("equipment_category", {}).get("name", "")],
            "attributes": {
                "Maliyet": cost_str,
                "Aƒüƒ±rlƒ±k": str(data.get("weight", 0)) + " lb",
                "Hasar": dmg_str,
                "Zƒ±rh Sƒ±nƒ±fƒ± (AC)": ac_str,
                "√ñzellikler": ", ".join([p["name"] for p in data.get("properties", [])])
            }
        }

    # Sƒ±nƒ±f ve Irk parserlarƒ± aynƒ± kalabilir veya detaylandƒ±rƒ±labilir
    def parse_class(self, data):
        return {"name": data.get("name"), "type": "Sƒ±nƒ±f (Class)", "description": f"Hit Die: d{data.get('hit_die')}", "attributes": {"Hit Die": f"d{data.get('hit_die')}"}}

    def parse_race(self, data):
        return {"name": data.get("name"), "type": "Irk (Race)", "description": f"Speed: {data.get('speed')}", "attributes": {"Hƒ±z": str(data.get("speed"))}}

--------------------------------------------------
Path: core/data_manager.py
--------------------------------------------------
import os
import json
import shutil
import uuid
from config import WORLDS_DIR, BASE_DIR, CACHE_DIR
from core.models import get_default_entity_structure
from core.api_client import DndApiClient
from core.locales import set_language

LIBRARY_DIR = os.path.join(CACHE_DIR, "library")
CACHE_FILE = os.path.join(CACHE_DIR, "reference_indexes.json")

class DataManager:
    def __init__(self):
        self.settings = self.load_settings()
        set_language(self.settings.get("language", "EN"))
        
        self.current_campaign_path = None
        # Varsayƒ±lan bo≈ü yapƒ±
        self.data = {
            "world_name": "", 
            "entities": {}, 
            "map_data": {"image_path": "", "pins": []},
            "sessions": [],
            "last_active_session_id": None # Son oturumu hatƒ±rlamak i√ßin
        }
        self.api_client = DndApiClient()
        self.reference_cache = {}
        
        if not os.path.exists(WORLDS_DIR): os.makedirs(WORLDS_DIR)
        self._load_reference_cache()

    def _load_reference_cache(self):
        if not os.path.exists(CACHE_DIR): os.makedirs(CACHE_DIR)
        if os.path.exists(CACHE_FILE):
            try:
                with open(CACHE_FILE, "r", encoding="utf-8") as f: self.reference_cache = json.load(f)
            except: self.reference_cache = {}
        else: self.reference_cache = {}

    def _save_reference_cache(self):
        if not os.path.exists(CACHE_DIR): os.makedirs(CACHE_DIR)
        with open(CACHE_FILE, "w", encoding="utf-8") as f: json.dump(self.reference_cache, f, indent=4)

    # --- AYARLAR ---
    def load_settings(self):
        path = os.path.join(CACHE_DIR, "settings.json")
        if os.path.exists(path):
            try:
                with open(path, "r", encoding="utf-8") as f: return json.load(f)
            except: pass
        return {"language": "EN"}

    def save_settings(self, settings):
        path = os.path.join(CACHE_DIR, "settings.json")
        if not os.path.exists(CACHE_DIR): os.makedirs(CACHE_DIR)
        with open(path, "w", encoding="utf-8") as f: json.dump(settings, f, indent=4)
        self.settings = settings
        set_language(settings.get("language", "EN"))

    def get_api_index(self, category):
        if category in self.reference_cache: return self.reference_cache[category]
        data = self.api_client.get_list(category)
        if data:
            self.reference_cache[category] = data
            self._save_reference_cache()
            return data
        return []

    # --- KAMPANYA Y√ñNETƒ∞Mƒ∞ ---
    def get_available_campaigns(self):
        if not os.path.exists(WORLDS_DIR): return []
        return [d for d in os.listdir(WORLDS_DIR) if os.path.isdir(os.path.join(WORLDS_DIR, d))]

    def create_campaign(self, world_name):
        folder = os.path.join(WORLDS_DIR, world_name)
        try:
            if not os.path.exists(folder): os.makedirs(folder)
            if not os.path.exists(os.path.join(folder, "assets")): os.makedirs(os.path.join(folder, "assets"))
            
            self.data = {
                "world_name": world_name, 
                "entities": {}, 
                "map_data": {"image_path": "", "pins": []},
                "sessions": [],
                "last_active_session_id": None
            }
            self.current_campaign_path = folder
            self.save_data()
            return True, "Olu≈üturuldu"
        except Exception as e: return False, str(e)

    def load_campaign_by_name(self, name):
        return self.load_campaign(os.path.join(WORLDS_DIR, name))

    def load_campaign(self, folder):
        path = os.path.join(folder, "data.json")
        if not os.path.exists(path): return False, "Dosya yok"
        try:
            with open(path, "r", encoding="utf-8") as f: self.data = json.load(f)
            
            # Migration
            if "sessions" not in self.data: self.data["sessions"] = []
            if "entities" not in self.data: self.data["entities"] = {}
            if "map_data" not in self.data: self.data["map_data"] = {"image_path": "", "pins": []}
            if "last_active_session_id" not in self.data: self.data["last_active_session_id"] = None
            
            for eid, ent in self.data["entities"].items():
                default = get_default_entity_structure(ent.get("type", "NPC"))
                for key, val in default.items():
                    if key not in ent: ent[key] = val
                if not ent.get("images") and ent.get("image_path"):
                    ent["images"] = [ent["image_path"]]

            self.current_campaign_path = folder
            return True, "Y√ºklendi"
        except Exception as e: return False, str(e)

    def save_data(self):
        if self.current_campaign_path:
            with open(os.path.join(self.current_campaign_path, "data.json"), "w", encoding="utf-8") as f:
                json.dump(self.data, f, indent=4, ensure_ascii=False)

    # --- SESSION Y√ñNETƒ∞Mƒ∞ ---
    def create_session(self, name):
        session_id = str(uuid.uuid4())
        new_session = {
            "id": session_id,
            "name": name,
            "date": "Bug√ºn",
            "notes": "",
            "logs": "",
            "combatants": [] # Yeni yapƒ±da burasƒ± dict (state) olabilir
        }
        if "sessions" not in self.data: self.data["sessions"] = []
        self.data["sessions"].append(new_session)
        self.set_active_session(session_id)
        self.save_data()
        return session_id

    def get_session(self, session_id):
        if "sessions" not in self.data: return None
        for s in self.data["sessions"]:
            if s["id"] == session_id: return s
        return None

    def save_session_data(self, session_id, notes, logs, combatants):
        if "sessions" not in self.data: return
        for s in self.data["sessions"]:
            if s["id"] == session_id:
                s["notes"] = notes
                s["logs"] = logs
                s["combatants"] = combatants # Artƒ±k state dict'i de olabilir
                self.set_active_session(session_id)
                self.save_data()
                break

    def set_active_session(self, session_id):
        self.data["last_active_session_id"] = session_id
        # save_data burada √ßaƒürƒ±lmaz, genellikle save_session_data i√ßinde kaydedilir zaten
        # ama anlƒ±k deƒüi≈üim i√ßin √ßaƒürƒ±labilir.
        
    def get_last_active_session_id(self):
        return self.data.get("last_active_session_id")

    # --- VARLIK Y√ñNETƒ∞Mƒ∞ ---
    def save_entity(self, eid, data):
        if not eid: eid = str(uuid.uuid4())
        if eid in self.data["entities"]: self.data["entities"][eid].update(data)
        else: self.data["entities"][eid] = data
        self.save_data()
        return eid

    def delete_entity(self, eid):
        if eid in self.data["entities"]:
            del self.data["entities"][eid]
            self.save_data()

    def get_entity_name(self, eid):
        if eid in self.data["entities"]:
            return self.data["entities"][eid].get("name")
        return None

    def fetch_from_api(self, category, query):
        for eid, ent in self.data["entities"].items():
            if ent["name"].lower() == query.lower() and ent["type"] == category:
                return True, "Veritabanƒ±nda zaten var.", eid
        
        parsed_data, msg = self.api_client.search(category, query)
        if not parsed_data: return False, msg, None
        return True, "API'den √ßekildi.", parsed_data

    def fetch_details_from_api(self, category, index_name):
        folder_map = {
            "Canavar": "monsters", "B√ºy√º (Spell)": "spells", "E≈üya (Equipment)": "equipment",
            "Sƒ±nƒ±f (Class)": "classes", "Irk (Race)": "races"
        }
        folder = folder_map.get(category)
        
        # 1. Cache Kontrol
        if folder:
            paths = [os.path.join(LIBRARY_DIR, folder, f"{index_name}.json")]
            if category == "E≈üya (Equipment)":
                paths.append(os.path.join(LIBRARY_DIR, "magic-items", f"{index_name}.json"))
            
            for local_path in paths:
                if os.path.exists(local_path):
                    try:
                        with open(local_path, "r", encoding="utf-8") as f:
                            raw = json.load(f)
                            return True, self.api_client.parse_dispatcher(category, raw)
                    except: pass

        # 2. API √áekim
        parsed_data, msg = self.api_client.search(category, index_name)
        if parsed_data: return True, parsed_data
        return False, msg

    def import_entity_with_dependencies(self, data):
        """API verisindeki baƒülƒ± b√ºy√ºleri indirip kaydeder."""
        detected_spells = data.pop("_detected_spell_indices", [])
        linked_spell_ids = []

        if detected_spells:
            print(f"üîÆ {len(detected_spells)} baƒülƒ± b√ºy√º indiriliyor...")
            for spell_index in detected_spells:
                success, spell_data = self.fetch_details_from_api("B√ºy√º (Spell)", spell_index)
                if success:
                    spell_name = spell_data.get("name")
                    existing_id = None
                    for eid, ent in self.data["entities"].items():
                        if ent.get("type") == "B√ºy√º (Spell)" and ent.get("name") == spell_name:
                            existing_id = eid; break
                    
                    if existing_id: linked_spell_ids.append(existing_id)
                    else:
                        new_id = self.save_entity(None, spell_data)
                        linked_spell_ids.append(new_id)

        if linked_spell_ids:
            if "spells" not in data: data["spells"] = []
            for sid in linked_spell_ids:
                if sid not in data["spells"]: data["spells"].append(sid)

        return self.save_entity(None, data)

    # --- HARƒ∞TA & RESƒ∞M ---
    def import_image(self, src):
        if not self.current_campaign_path: return None
        fname = f"{uuid.uuid4().hex}_{os.path.basename(src)}"
        dest = os.path.join(self.current_campaign_path, "assets", fname)
        shutil.copy2(src, dest)
        return os.path.join("assets", fname)

    def import_pdf(self, src):
        if not self.current_campaign_path: return None
        fname = f"{uuid.uuid4().hex}_{os.path.basename(src)}"
        dest = os.path.join(self.current_campaign_path, "assets", fname)
        shutil.copy2(src, dest)
        return os.path.join("assets", fname)

    def get_full_path(self, rel):
        return os.path.join(self.current_campaign_path, rel) if self.current_campaign_path and rel else None
    
    def set_map_image(self, rel): self.data["map_data"]["image_path"] = rel; self.save_data()
    def add_pin(self, x, y, eid): self.data["map_data"]["pins"].append({"id": str(uuid.uuid4()), "x": x, "y": y, "entity_id": eid}); self.save_data()
    def move_pin(self, pid, x, y):
        for p in self.data["map_data"]["pins"]:
             if p.get("id") == pid: p["x"]=x; p["y"]=y; break
        self.save_data()
    def remove_specific_pin(self, pid):
        self.data["map_data"]["pins"] = [p for p in self.data["map_data"]["pins"] if p.get("id") != pid]
        self.save_data()

    def search_in_library(self, category, search_text):
        results = []
        search_text = search_text.lower()
        cats = [category] if category in self.reference_cache else list(self.reference_cache.keys())
        for c in cats:
            for item in self.reference_cache.get(c, []):
                if search_text in item["name"].lower():
                    results.append({"id": f"lib_{c}_{item['index']}", "name": item["name"], "type": c, "is_library": True})
        return results

--------------------------------------------------
Path: core/locales.py
--------------------------------------------------
# Localization Dictionary

# Current Language Global Variable
CURRENT_LANGUAGE = "EN"

def set_language(lang_code):
    global CURRENT_LANGUAGE
    if lang_code in ["EN", "TR"]:
        CURRENT_LANGUAGE = lang_code

def tr(key):
    """Returns the translated string for the given key."""
    return TRANSLATIONS.get(CURRENT_LANGUAGE, {}).get(key, key)

TRANSLATIONS = {
    "EN": {
        # General
        "BTN_SAVE": "Save",
        "BTN_DELETE": "Delete",
        "BTN_CANCEL": "Cancel",
        "BTN_ADD": "Add",
        "BTN_REMOVE": "Remove",
        "BTN_IMPORT": "Import",
        "BTN_CLOSE": "Close",
        "MSG_SUCCESS": "Success",
        "MSG_ERROR": "Error",
        "MSG_WARNING": "Warning",
        "LBL_NAME": "Name:",
        "LBL_TYPE": "Type:",
        "LBL_DESC": "Description:",
        
        # Main Window
        "WIN_TITLE": "Dungeon Master Tool",
        "BTN_PLAYER_SCREEN": "üì∫ Toggle Player Screen",
        "BTN_EXPORT": "üìÑ Export (TXT)",
        "LBL_CAMPAIGN": "World: ",
        "TAB_DB": "Database & Characters",
        "TAB_MAP": "Maps",
        "TAB_SESSION": "Session",
        
        # Map Tab
        "BTN_LOAD_MAP": "üñºÔ∏è Load Map",
        "BTN_PROJECT_MAP": "üåç Project Map",
        "MSG_SELECT_MAP": "Select Map Image",
        "MSG_NO_PLAYER_SCREEN": "First open the Player Screen.",
        "MSG_ADD_PIN": "Add Pin",
        "MSG_SELECT_ENTITY": "Select Entity:",
        "MSG_NO_ENTITY_FOR_PIN": "No suitable entity found to pin.",
        "MSG_DELETE_PIN": "Remove this pin?",
        "MENU_INSPECT": "Inspect",
        "MENU_MOVE": "Move",
        "MENU_DELETE": "Delete",
        
        # Bulk Downloader
        "TITLE_DOWNLOADER": "Bulk Downloader",
        "LBL_SELECT_CATS": "Select Categories:",
        "BTN_START_DOWNLOAD": "Start Download",
        "MSG_DOWNLOAD_COMPLETE": "Download Complete!",
        
        # Campaign Selector
        "TITLE_SELECT_WORLD": "Select or Create World",
        "BTN_CREATE_WORLD": "Create New World",
        "LBL_SELECT_WORLD": "Select World:",
        "MSG_ENTER_WORLD_NAME": "Enter World Name:",
        "LBL_LANGUAGE": "Language / Dil:",
        
        # Database Tab
        "BTN_NEW_ENTITY": "‚ûï New Entity",
        "BTN_API_BROWSER": "üåê API Browser",
        "LBL_SEARCH": "Search...",
        "LBL_FILTER": "Filter",
        "BTN_NEW_ENTITY": "‚ûï New Entity",
        "BTN_API_BROWSER": "üåê API Browser",
        "BTN_DOWNLOAD_ALL": "‚¨áÔ∏è Download All (Offline)",
        "LBL_CHECK_LIBRARY": "Include Library Results",
        "LBL_SEARCH": "Search...",
        "LBL_FILTER": "Filter",
        "CAT_ALL": "All",
        
        # API Browser
        "TITLE_API": "D&D 5e API Browser",
        "LBL_CATEGORY": "Category:",
        "LBL_SEARCH_API": "Search (Eng)...",
        "MSG_LOADING": "Loading...",
        "MSG_IMPORTED": "Imported successfully.",
        "MSG_EXISTS": "Already exists.",
        
        # NPC Sheet
        "BTN_SELECT_IMG": "Select Image",
        "BTN_SHOW_PLAYER": "üëÅÔ∏è Show to Player",
        "BTN_SHOW_STATS": "üìÑ Project Card",
        "LBL_TAGS": "Tags:",
        "LBL_LOCATION": "Location:",
        "LBL_RESIDENTS": "Residents:",
        "GRP_STATS": "Stats",
        "GRP_SPELLS": "Spells",
        "GRP_ACTIONS": "Actions",
        "GRP_INVENTORY": "Inventory",
        "TAB_STATS": "üìä Stats",
        "TAB_SPELLS": "‚ú® Spells",
        "TAB_ACTIONS": "‚öîÔ∏è Actions",
        "TAB_INV": "üéí Inventory",
        "TAB_DOCS": "üìÇ Docs & PDFs",
        "Lore": "Lore",
        
        # Extended Stats
        "LBL_SAVES": "Saving Throws",
        "LBL_VULN": "Damage Vuln.",
        "LBL_RESIST": "Damage Resist.",
        "LBL_DMG_IMMUNE": "Dmg. Immunities",
        "LBL_COND_IMMUNE": "Cond. Immunities",
        "GRP_COMBAT": "Combat",
        "GRP_DEFENSE": "Defense & Traits",
        "LBL_PROF_BONUS": "Proficiency Bonus",
        "LBL_PASSIVE_PERC": "Passive Perception",
        "LBL_INIT_BONUS": "Initiative Bonus",
        "LBL_SKILLS": "Skills",

        # Dialogs
        "GRP_PDF": "Attached PDF Files",
        "BTN_OPEN_PDF": "Open PDF",
        "BTN_NEXT_TURN": "Next Turn ‚ñ∂",
        "BTN_CLEAR_COMBAT": "Clear Tracker",
        "BTN_QUICK_ADD": "Quick Add",
        "LBL_INIT": "Init",
        "LBL_HP": "HP",
        "BTN_PROJECT_PDF": "üëÅÔ∏è Project PDF",
        "MSG_SELECT_PDF": "Select PDF File",
        "MSG_CONFIRM_DELETE_PDF": "Remove this PDF file?",
        
        # Session & Combat
        "TITLE_COMBAT": "‚öîÔ∏è Combat & Initiative",
        "GRP_DICE": "Roll Dice",
        "BTN_NEW_SESSION": "üìù New Session",
        "BTN_LOAD_SESSION": "Load",
        "LBL_LOG": "üìú Event Log",
        "LBL_NOTES": "üïµÔ∏è DM Notes",
        "BTN_ADD_LOG": "Add Log",
        "HEADER_NAME": "Name",
        "HEADER_INIT": "Init",
        "HEADER_AC": "AC",
        "HEADER_HP": "HP",
        "HEADER_COND": "Condition",
        "BTN_ROLL_INIT": "üé≤ Roll Init",
        "BTN_CLEAR": "üóëÔ∏è Clear",
        "BTN_ADD_PLAYERS": "Add All Players",
        "BTN_CLEAR_NPCS": "Clear NPCs",
        "BTN_CLEAR_ALL": "Clear All",
        "MENU_ADD_COND": "ü©∏ Add/Remove Condition",
        "MENU_REMOVE_COMBAT": "‚ùå Remove from Combat",
    },
    
    "TR": {
        # General
        "BTN_SAVE": "Kaydet",
        "BTN_DELETE": "Sil",
        "BTN_CANCEL": "ƒ∞ptal",
        "BTN_ADD": "Ekle",
        "BTN_REMOVE": "Kaldƒ±r",
        "BTN_IMPORT": "ƒ∞√ße Aktar",
        "BTN_CLOSE": "Kapat",
        "MSG_SUCCESS": "Ba≈üarƒ±lƒ±",
        "MSG_ERROR": "Hata",
        "MSG_WARNING": "Uyarƒ±",
        "LBL_NAME": "ƒ∞sim:",
        "LBL_TYPE": "Tip:",
        "LBL_DESC": "A√ßƒ±klama:",
        
        # Main Window
        "WIN_TITLE": "Zindan Efendisi Aracƒ±",
        "BTN_PLAYER_SCREEN": "üì∫ Oyuncu Ekranƒ±nƒ± A√ß/Kapat",
        "BTN_EXPORT": "üìÑ Dƒ±≈üa Aktar (TXT)",
        "LBL_CAMPAIGN": "D√ºnya: ",
        "TAB_DB": "Veritabanƒ± & Karakterler",
        "TAB_MAP": "Haritalar",
        "TAB_SESSION": "Oturum",

        # Map Tab
        "BTN_LOAD_MAP": "üñºÔ∏è Harita Y√ºkle",
        "BTN_PROJECT_MAP": "üåç Haritayƒ± Yansƒ±t",
        "MSG_SELECT_MAP": "Harita Se√ß",
        "MSG_NO_PLAYER_SCREEN": "√ñnce Oyuncu Ekranƒ±nƒ± a√ßƒ±n.",
        "MSG_ADD_PIN": "Pin Ekle",
        "MSG_SELECT_ENTITY": "Varlƒ±k Se√ß:",
        "MSG_NO_ENTITY_FOR_PIN": "Haritaya eklenebilecek uygun bir varlƒ±k bulunamadƒ±.",
        "MSG_DELETE_PIN": "Bu pini kaldƒ±rmak istiyor musun?",
        "MENU_INSPECT": "ƒ∞ncele",
        "MENU_MOVE": "Ta≈üƒ±",
        "MENU_DELETE": "Sil",
        
        # Bulk Downloader
        "TITLE_DOWNLOADER": "Toplu ƒ∞ndirici",
        "LBL_SELECT_CATS": "Kategorileri Se√ß:",
        "BTN_START_DOWNLOAD": "ƒ∞ndirmeyi Ba≈ülat",
        "MSG_DOWNLOAD_COMPLETE": "ƒ∞ndirme Tamamlandƒ±!",
        
        # Campaign Selector
        "TITLE_SELECT_WORLD": "D√ºnya Se√ß veya Olu≈ütur",
        "BTN_CREATE_WORLD": "Yeni D√ºnya Olu≈ütur",
        "LBL_SELECT_WORLD": "D√ºnya Se√ßiniz:",
        "MSG_ENTER_WORLD_NAME": "D√ºnya Adƒ± Giriniz:",
        "LBL_LANGUAGE": "Language / Dil:",
        
        # Database Tab
        "BTN_NEW_ENTITY": "‚ûï Yeni Varlƒ±k",
        "BTN_API_BROWSER": "üåê API Tarayƒ±cƒ±",
        "LBL_SEARCH": "Ara...",
        "LBL_FILTER": "Filtre",
        "BTN_NEW_ENTITY": "‚ûï Yeni Varlƒ±k",
        "BTN_API_BROWSER": "üåê K√ºt√ºphaneyi Tara (Detaylƒ±)",
        "BTN_DOWNLOAD_ALL": "‚¨áÔ∏è T√ºm Veritabanƒ±nƒ± ƒ∞ndir (Offline)",
        "LBL_CHECK_LIBRARY": "K√ºt√ºphane sonu√ßlarƒ±nƒ± dahil et",
        "LBL_SEARCH": "Ara...",
        "LBL_FILTER": "Filtre",
        "CAT_ALL": "T√ºm√º",
        
        # API Browser
        "TITLE_API": "D&D 5e API Tarayƒ±cƒ±",
        "LBL_CATEGORY": "Kategori:",
        "LBL_SEARCH_API": "Ara (ƒ∞ng)...",
        "MSG_LOADING": "Y√ºkleniyor...",
        "MSG_IMPORTED": "Ba≈üarƒ±yla i√ße aktarƒ±ldƒ±.",
        "MSG_EXISTS": "Zaten mevcut.",
        
        # NPC Sheet
        "BTN_SELECT_IMG": "Resim Se√ß",
        "BTN_SHOW_PLAYER": "üëÅÔ∏è Oyuncuya G√∂ster",
        "BTN_SHOW_STATS": "üìÑ Kartƒ± Yansƒ±t",
        "LBL_TAGS": "Etiketler:",
        "LBL_LOCATION": "Konum:",
        "LBL_RESIDENTS": "Sakinler:",
        "GRP_STATS": "ƒ∞statistikler",
        "GRP_SPELLS": "B√ºy√ºler",
        "GRP_ACTIONS": "Eylemler",
        "GRP_INVENTORY": "Envanter",
        "TAB_STATS": "üìä ƒ∞statistikler",
        "TAB_SPELLS": "‚ú® B√ºy√ºler",
        "TAB_ACTIONS": "‚öîÔ∏è Eylemler",
        "TAB_ACTIONS": "‚öîÔ∏è Eylemler",
        "TAB_INV": "üéí Envanter",
        "TAB_DOCS": "üìÇ Belgeler & PDF",
        
        # Extended Stats
        "LBL_SAVES": "Kurtarma Zarlarƒ±",
        "LBL_VULN": "Hasar Zaafiyetleri",
        "LBL_RESIST": "Hasar Diren√ßleri",
        "LBL_DMG_IMMUNE": "Hasar Baƒüƒ±≈üƒ±klƒ±klarƒ±",
        "LBL_COND_IMMUNE": "Durum Baƒüƒ±≈üƒ±klƒ±klarƒ±",
        "GRP_COMBAT": "Sava≈ü √ñzellikleri",
        "GRP_DEFENSE": "Savunma & Nitelikler",
        "LBL_PROF_BONUS": "Ustalƒ±k Bonusu",
        "LBL_PASSIVE_PERC": "Pasif Algƒ±",
        "LBL_INIT_BONUS": "ƒ∞nisiyatif Bonusu",
        "LBL_SKILLS": "Yetenekler (Skills)",
        
        "GRP_PDF": "Ekli PDF Dosyalarƒ±",
        "BTN_OPEN_PDF": "PDF A√ß",
        "BTN_NEXT_TURN": "Sƒ±radaki ‚ñ∂",
        "BTN_CLEAR_COMBAT": "Temizle",
        "BTN_QUICK_ADD": "Hƒ±zlƒ± Ekle",
        "LBL_INIT": "ƒ∞nisiyatif",
        "LBL_HP": "CP",
        "BTN_PROJECT_PDF": "üëÅÔ∏è PDF Yansƒ±t",
        "MSG_SELECT_PDF": "PDF Dosyasƒ± Se√ß",
        "MSG_CONFIRM_DELETE_PDF": "Bu PDF dosyasƒ±nƒ± silmek istiyor musun?",
        
        # Session & Combat
        "TITLE_COMBAT": "‚öîÔ∏è Sava≈ü & ƒ∞nisiyatif",
        "GRP_DICE": "Zar At",
        "BTN_NEW_SESSION": "üìù Yeni Oturum",
        "BTN_LOAD_SESSION": "Y√ºkle",
        "LBL_LOG": "üìú Olay G√ºnl√ºƒü√º",
        "LBL_NOTES": "üïµÔ∏è DM Notlarƒ±",
        "BTN_ADD_LOG": "Log Ekle",
        "HEADER_NAME": "ƒ∞sim",
        "HEADER_INIT": "ƒ∞nisiyatif",
        "HEADER_AC": "ZS (AC)",
        "HEADER_HP": "CY (HP)",
        "HEADER_COND": "Durum",
        "BTN_ROLL_INIT": "üé≤ ƒ∞nisiyatif At",
        "BTN_CLEAR": "üóëÔ∏è Temizle",
        "BTN_ADD_PLAYERS": "T√ºm Oyuncularƒ± Ekle",
        "BTN_CLEAR_NPCS": "NPC'leri Temizle",
        "BTN_CLEAR_ALL": "T√ºm√ºn√º Temizle",
        "MENU_ADD_COND": "ü©∏ Durum Ekle/Kaldƒ±r",
        "MENU_REMOVE_COMBAT": "‚ùå Sava≈ütan √áƒ±kar",
    }
}


--------------------------------------------------
Path: core/models.py
--------------------------------------------------
ENTITY_SCHEMAS = {
    "NPC": [
        ("Irk", "text", None),
        ("Sƒ±nƒ±f", "text", None),
        ("Seviye", "text", None), 
        ("Tavƒ±r", "combo", ["Dost", "N√∂tr", "D√º≈üman"]),
        ("Konum", "text", None)
    ],
    "Canavar": [
        ("Challenge Rating (CR)", "text", None),
        ("Saldƒ±rƒ± Tipi", "text", None)
    ],
    # ... Diƒüer ≈üemalar aynƒ± kalsƒ±n ...
    "B√ºy√º (Spell)": [
        ("Seviye", "combo", ["Cantrip", "1", "2", "3", "4", "5", "6", "7", "8", "9"]),
        ("Okul (School)", "text", None),
        ("S√ºre (Casting Time)", "text", None),
        ("Menzil (Range)", "text", None),
        ("S√ºreklilik (Duration)", "text", None),
        ("Bile≈üenler (Components)", "text", None)
    ],
    "E≈üya (Equipment)": [
        ("E≈üya Tipi", "text", None),
        ("Maliyet", "text", None),
        ("Aƒüƒ±rlƒ±k", "text", None),
        ("Hasar/Zƒ±rh", "text", None),
        ("√ñzellikler", "text", None)
    ],
    "Sƒ±nƒ±f (Class)": [("Hit Die", "text", None), ("Ana Statlar", "text", None), ("Zƒ±rh/Silah Yetkinlikleri", "text", None)],
    "Irk (Race)": [("Hƒ±z", "text", None), ("Boyut", "combo", ["Small", "Medium", "Large"]), ("Hizalanma Eƒüilimi", "text", None), ("Dil", "text", None)],
    "Mekan": [("Tehlike Seviyesi", "combo", ["G√ºvenli", "D√º≈ü√ºk", "Orta", "Y√ºksek"]), ("Ortam", "text", None)],
    "Oyuncu": [("Sƒ±nƒ±f", "text", None), ("Irk", "text", None), ("Seviye", "text", None)],
    "G√∂rev": [("Durum", "combo", ["Ba≈ülamadƒ±", "Aktif", "Tamamlandƒ±"]), ("G√∂revi Veren", "text", None), ("√ñd√ºl", "text", None)],
    "Lore": [("Kategori", "combo", ["Tarih", "Coƒürafya", "Din", "K√ºlt√ºr", "Diƒüer"]), ("Gizli Bilgi", "text", None)]
}

def get_default_entity_structure(entity_type="NPC"):
    return {
        "name": "Yeni Kayƒ±t",
        "type": entity_type,
        "description": "",
        "images": [], # YENƒ∞: √áoklu resim desteƒüi
        "image_path": "", # Geriye d√∂n√ºk uyumluluk i√ßin (varsa ilk resim buraya da yazƒ±lƒ±r)
        "tags": [],
        "attributes": {},
        "stats": {"STR": 10, "DEX": 10, "CON": 10, "INT": 10, "WIS": 10, "CHA": 10},
        "combat_stats": {"hp": "", "max_hp": "", "ac": "", "speed": "", "cr": "", "xp": "", "initiative": ""},
        
        # --- Lƒ∞STELER ---
        "traits": [],
        "actions": [],
        "reactions": [],
        "legendary_actions": [],
        
        # B√ºy√ºler
        "spells": [],             # ID Listesi (Linked)
        "custom_spells": [],      # Manuel Kartlar
        
        # Envanter (YENƒ∞LENEN KISIM)
        "equipment_ids": [],      # YENƒ∞: ID Listesi (Linked Items)
        "inventory": [],          # Manuel Kartlar (Mevcut yapƒ±)
        
        "pdfs": [],               # PDF Dosyalarƒ±
        "location_id": None,

        # --- Geli≈ümi≈ü Statlar (NPC/Canavar i√ßin) ---
        "saving_throws": "",
        "damage_vulnerabilities": "",
        "damage_resistances": "",
        "damage_immunities": "",
        "condition_immunities": "",
        "proficiency_bonus": "",
        "passive_perception": "",
        "skills": ""
    }

--------------------------------------------------
Path: worlds/Aegis/data.json
--------------------------------------------------
{
    "world_name": "Aegis",
    "entities": {},
    "map_data": {
        "image_path": "",
        "pins": []
    },
    "sessions": [],
    "last_active_session_id": null
}

--------------------------------------------------
Path: ui/player_window.py
--------------------------------------------------
from PyQt6.QtWidgets import QMainWindow, QWidget, QVBoxLayout, QStackedWidget, QTextBrowser
from PyQt6.QtCore import Qt, QUrl
from PyQt6.QtGui import QPixmap
from PyQt6.QtWebEngineWidgets import QWebEngineView # YENƒ∞ IMPORT
from ui.widgets.image_viewer import ImageViewer

class PlayerWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Player View - Second Screen")
        self.resize(800, 600)
        self.setStyleSheet("background-color: black;")
        
        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout(central)
        layout.setContentsMargins(0, 0, 0, 0)
        
        # STACKED WIDGET (Sayfalar arasƒ± ge√ßi≈ü i√ßin)
        self.stack = QStackedWidget()
        
        # SAYFA 0: RESƒ∞M G√ñR√úNT√úLEYƒ∞Cƒ∞ (Zoom/Pan √∂zellikli)
        self.image_viewer = ImageViewer()
        self.stack.addWidget(self.image_viewer)
        
        # SAYFA 1: KARAKTER KARTI (HTML Stat Block)
        self.stat_viewer = QTextBrowser()
        self.stat_viewer.setStyleSheet("""
            QTextBrowser {
                background-color: #1a1a1a;
                color: #e0e0e0;
                border: none;
                padding: 20px;
                font-family: 'Segoe UI', serif;
            }
        """)
        self.stack.addWidget(self.stat_viewer)

        # SAYFA 2: PDF G√ñR√úNT√úLEYƒ∞Cƒ∞ (WebEngine)
        self.pdf_viewer = QWebEngineView()
        self.pdf_viewer.setStyleSheet("background-color: #333;")
        self.stack.addWidget(self.pdf_viewer)
        
        layout.addWidget(self.stack)

    def show_image(self, pixmap):
        """Sadece resmi g√∂sterir"""
        self.stack.setCurrentIndex(0)
        self.image_viewer.set_image(pixmap)

    def show_stat_block(self, html_content):
        """Karakter kartƒ±nƒ± (HTML) g√∂sterir"""
        self.stack.setCurrentIndex(1)
        self.stat_viewer.setHtml(html_content)

    def show_pdf(self, pdf_path):
        """PDF dosyasƒ±nƒ± g√∂sterir"""
        self.stack.setCurrentIndex(2)
        # Ayarlarƒ± etkinle≈ütir
        self.pdf_viewer.settings().setAttribute(self.pdf_viewer.settings().WebAttribute.PluginsEnabled, True)
        self.pdf_viewer.settings().setAttribute(self.pdf_viewer.settings().WebAttribute.PdfViewerEnabled, True)
        
        local_url = QUrl.fromLocalFile(pdf_path)
        self.pdf_viewer.setUrl(local_url)

--------------------------------------------------
Path: ui/campaign_selector.py
--------------------------------------------------
from PyQt6.QtWidgets import (QDialog, QVBoxLayout, QListWidget, QPushButton, 
                             QLineEdit, QHBoxLayout, QLabel, QMessageBox, QWidget, QComboBox) # QComboBox eklendi
from core.locales import tr, set_language
from PyQt6.QtCore import Qt

class CampaignSelector(QDialog):
    def __init__(self, data_manager):
        super().__init__()
        self.dm = data_manager
        self.selected_campaign = None
        
        self.selected_campaign = None
        
        self.setWindowTitle("Select World")
        self.setFixedSize(400, 500)
        self.setStyleSheet("""
            QDialog { background-color: #1e1e1e; color: white; }
            QListWidget { background-color: #252526; border: 1px solid #333; font-size: 16px; }
            QListWidget::item { padding: 10px; }
            QListWidget::item:selected { background-color: #007acc; }
            QLineEdit { padding: 8px; background-color: #333; color: white; border: 1px solid #555; }
            QPushButton { padding: 10px; background-color: #444; color: white; border: none; font-weight: bold; }
            QPushButton:hover { background-color: #555; }
            QPushButton#createBtn { background-color: #2e7d32; }
            QPushButton#loadBtn { background-color: #007acc; }
        """)
        
        self.init_ui()
        self.refresh_list()

    def init_ui(self):
        layout = QVBoxLayout(self)
        
        # Ba≈ülƒ±k
        # Ba≈ülƒ±k
        self.lbl_title = QLabel("üîÆ Select World")
        self.lbl_title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.lbl_title.setStyleSheet("font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #ffa500;")
        layout.addWidget(self.lbl_title)
        
        # Liste
        self.list_widget = QListWidget()
        self.list_widget.itemDoubleClicked.connect(self.load_campaign) # √áift tƒ±klama ile a√ß
        layout.addWidget(self.list_widget)
        
        # Y√ºkle Butonu
        # Y√ºkle Butonu
        self.btn_load = QPushButton("Load")
        self.btn_load.setObjectName("loadBtn")
        self.btn_load.clicked.connect(self.load_campaign)
        layout.addWidget(self.btn_load)
        
        layout.addSpacing(20)
        
        # Yeni Olu≈üturma Alanƒ±
        create_layout = QHBoxLayout()
        self.inp_new_name = QLineEdit()
        self.inp_new_name.setPlaceholderText("Yeni D√ºnya Adƒ±...")
        
        self.btn_create = QPushButton("Create")
        self.btn_create.setObjectName("createBtn")
        self.btn_create.clicked.connect(self.create_campaign)
        
        create_layout.addWidget(self.inp_new_name)
        create_layout.addWidget(self.btn_create)
        
        layout.addLayout(create_layout)

        # Dil Se√ßimi (Alt Kƒ±sƒ±m)
        lang_layout = QHBoxLayout()
        self.lbl_lang = QLabel(tr("LBL_LANGUAGE")) # "Language / Dil:"
        self.combo_lang = QComboBox()
        self.combo_lang.addItems(["English", "T√ºrk√ße"])
        
        # Mevcut dili se√ß
        current_lang = self.dm.settings.get("language", "EN")
        self.combo_lang.setCurrentIndex(1 if current_lang == "TR" else 0)
        
        self.combo_lang.currentIndexChanged.connect(self.change_language)
        
        lang_layout.addStretch()
        lang_layout.addWidget(self.lbl_lang)
        lang_layout.addWidget(self.combo_lang)
        layout.addLayout(lang_layout)

        self.update_texts()

    def change_language(self, index):
        code = "TR" if index == 1 else "EN"
        self.dm.save_settings({"language": code})
        self.update_texts()

    def update_texts(self):
        self.setWindowTitle(tr("TITLE_SELECT_WORLD"))
        self.lbl_title.setText(tr("TITLE_SELECT_WORLD"))
        self.btn_load.setText(tr("BTN_LOAD_SESSION")) # "Load" / "Y√ºkle"
        self.inp_new_name.setPlaceholderText(tr("MSG_ENTER_WORLD_NAME"))
        self.btn_create.setText(tr("BTN_CREATE_WORLD"))
        self.lbl_lang.setText(tr("LBL_LANGUAGE"))

    def refresh_list(self):
        self.list_widget.clear()
        campaigns = self.dm.get_available_campaigns()
        self.list_widget.addItems(campaigns)

    def load_campaign(self):
        # Se√ßili item var mƒ±?
        current_item = self.list_widget.currentItem()
        if not current_item:
            QMessageBox.warning(self, "Uyarƒ±", "L√ºtfen bir d√ºnya se√ßin.")
            return
            
        world_name = current_item.text()
        success, msg = self.dm.load_campaign_by_name(world_name)
        
        if success:
            self.selected_campaign = world_name
            self.accept() # Diyaloƒüu kapat ve "Ba≈üarƒ±lƒ±" kodu d√∂n
        else:
            QMessageBox.critical(self, "Hata", msg)

    def create_campaign(self):
        name = self.inp_new_name.text().strip()
        if not name:
            QMessageBox.warning(self, "Uyarƒ±", "ƒ∞sim bo≈ü olamaz.")
            return
            
        # Zaten var mƒ± kontrol√º (basit)
        if name in self.dm.get_available_campaigns():
             QMessageBox.warning(self, "Uyarƒ±", "Bu isimde bir d√ºnya zaten var.")
             return

        success, msg = self.dm.create_campaign(name)
        if success:
            self.selected_campaign = name
            self.accept()
        else:
            QMessageBox.critical(self, "Hata", msg)

--------------------------------------------------
Path: ui/workers.py
--------------------------------------------------
from PyQt6.QtCore import QThread, pyqtSignal

class ApiSearchWorker(QThread):
    finished = pyqtSignal(bool, object, str) # success, data, message

    def __init__(self, data_manager, category, query):
        super().__init__()
        self.data_manager = data_manager
        self.category = category
        self.query = query

    def run(self):
        try:
            # fetch_from_api artƒ±k ya (True, msg, ID) d√∂n√ºyor (zaten varsa)
            # ya da (True, msg, DATA_DICT) d√∂n√ºyor (yeni √ßekildiyse)
            success, msg, result = self.data_manager.fetch_from_api(self.category, self.query)
            self.finished.emit(success, result, msg)
        except Exception as e:
            self.finished.emit(False, {}, str(e))

class ApiListWorker(QThread):
    finished = pyqtSignal(list)

    def __init__(self, api_client, category):
        super().__init__()
        self.api_client = api_client
        self.category = category

    def run(self):
        data = self.api_client.get_list(self.category)
        self.finished.emit(data)


--------------------------------------------------
Path: ui/widgets/aspect_ratio_label.py
--------------------------------------------------
from PyQt6.QtWidgets import QLabel
from PyQt6.QtGui import QPixmap
from PyQt6.QtCore import Qt

class AspectRatioLabel(QLabel):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.setMinimumSize(100, 100)
        self.setStyleSheet("border: 2px dashed #444; background-color: #222; border-radius: 8px;")
        self._pixmap = None

    def setPixmap(self, pixmap):
        self._pixmap = pixmap
        self.update_image()

    def resizeEvent(self, event):
        self.update_image()
        super().resizeEvent(event)

    def update_image(self):
        if self._pixmap and not self._pixmap.isNull():
            scaled = self._pixmap.scaled(self.size(), Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation)
            super().setPixmap(scaled)
        else:
            super().setPixmap(QPixmap())
            self.setText("Resim Yok")

--------------------------------------------------
Path: ui/widgets/combat_tracker.py
--------------------------------------------------
from PyQt6.QtWidgets import (QWidget, QVBoxLayout, QTableWidget, QTableWidgetItem, 
                             QHBoxLayout, QPushButton, QHeaderView, QInputDialog, 
                             QMenu, QMessageBox, QFrame, QLineEdit, QFileDialog, 
                             QDialog, QListWidget, QListWidgetItem, QLabel, QAbstractItemView)
from PyQt6.QtGui import QAction, QColor, QBrush, QCursor, QIcon, QPixmap
from PyQt6.QtCore import Qt, pyqtSignal, QSize
from core.locales import tr
from ui.windows.battle_map_window import BattleMapWindow
import random
import os

# D&D 5e Standart Durumlar
CONDITIONS = [
    "Blinded", "Charmed", "Deafened", "Frightened", "Grappled", "Incapacitated", 
    "Invisible", "Paralyzed", "Petrified", "Poisoned", "Prone", "Restrained", 
    "Stunned", "Unconscious", "Exhaustion"
]

# --- YENƒ∞: HARƒ∞TA SE√áƒ∞M Dƒ∞YALOƒûU ---
class MapSelectorDialog(QDialog):
    def __init__(self, assets_path, parent=None):
        super().__init__(parent)
        self.assets_path = assets_path
        self.selected_file = None # Se√ßilen dosya adƒ± (√∂r: map.png)
        self.is_new_import = False # Yeni y√ºkle butonuna basƒ±ldƒ± mƒ±?
        
        self.setWindowTitle("Harita Se√ßimi")
        self.setFixedSize(600, 500)
        self.setStyleSheet("background-color: #1e1e1e; color: white;")
        
        self.init_ui()
        self.load_maps()

    def init_ui(self):
        layout = QVBoxLayout(self)
        
        lbl = QLabel("Kayƒ±tlƒ± Haritalar (Assets):")
        lbl.setStyleSheet("font-weight: bold; font-size: 14px; color: #ffb74d;")
        layout.addWidget(lbl)
        
        # Resim Listesi (Icon Mode)
        self.list_widget = QListWidget()
        self.list_widget.setViewMode(QListWidget.ViewMode.IconMode)
        self.list_widget.setIconSize(QSize(150, 150))
        self.list_widget.setResizeMode(QListWidget.ResizeMode.Adjust)
        self.list_widget.setSpacing(10)
        self.list_widget.setStyleSheet("""
            QListWidget { background-color: #252526; border: 1px solid #444; }
            QListWidget::item { border: 1px solid transparent; padding: 5px; }
            QListWidget::item:selected { background-color: #333; border: 2px solid #007acc; border-radius: 5px; }
        """)
        self.list_widget.itemDoubleClicked.connect(self.select_existing)
        layout.addWidget(self.list_widget)
        
        # Butonlar
        btn_layout = QHBoxLayout()
        
        self.btn_import = QPushButton("üìÇ Yeni Harita Y√ºkle")
        self.btn_import.setStyleSheet("background-color: #2e7d32; color: white; padding: 8px; font-weight: bold;")
        self.btn_import.clicked.connect(self.select_new)
        
        self.btn_select = QPushButton("Se√ßili Haritayƒ± A√ß")
        self.btn_select.setStyleSheet("background-color: #007acc; color: white; padding: 8px; font-weight: bold;")
        self.btn_select.clicked.connect(self.select_existing)
        
        btn_layout.addWidget(self.btn_import)
        btn_layout.addStretch()
        btn_layout.addWidget(self.btn_select)
        
        layout.addLayout(btn_layout)

    def load_maps(self):
        if not os.path.exists(self.assets_path):
            return
            
        valid_extensions = {".png", ".jpg", ".jpeg", ".bmp"}
        
        files = [f for f in os.listdir(self.assets_path) 
                 if os.path.splitext(f)[1].lower() in valid_extensions]
        
        for f in files:
            full_path = os.path.join(self.assets_path, f)
            
            # Thumbnail olu≈ütur
            icon = QIcon(full_path)
            item = QListWidgetItem(icon, f)
            item.setData(Qt.ItemDataRole.UserRole, f) # Dosya adƒ±nƒ± sakla
            
            self.list_widget.addItem(item)

    def select_existing(self):
        current_item = self.list_widget.currentItem()
        if current_item:
            self.selected_file = current_item.data(Qt.ItemDataRole.UserRole)
            self.accept()
        else:
            QMessageBox.warning(self, "Uyarƒ±", "L√ºtfen listeden bir harita se√ßin.")

    def select_new(self):
        self.is_new_import = True
        self.accept()


# --- COMBAT TRACKER ANA SINIF ---
class CombatTracker(QWidget):
    data_changed_signal = pyqtSignal()

    def __init__(self, data_manager):
        super().__init__()
        self.dm = data_manager
        self.current_turn_index = -1
        self.battle_map_window = None 
        
        # Session State Verileri
        self.current_map_path = None # Relative path (assets/...)
        self.current_token_size = 50
        self.token_positions = {} 
        
        self.init_ui()

    def init_ui(self):
        layout = QVBoxLayout(self)
        
        # TABLO
        self.table = QTableWidget()
        self.table.setColumnCount(5)
        self.table.setHorizontalHeaderLabels([tr("HEADER_NAME"), tr("HEADER_INIT"), tr("HEADER_AC"), tr("HEADER_HP"), tr("HEADER_COND")])
        self.table.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
        self.table.horizontalHeader().setSectionResizeMode(4, QHeaderView.ResizeMode.Stretch)
        self.table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.table.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        
        self.table.customContextMenuRequested.connect(self.open_context_menu)
        self.table.itemChanged.connect(self.on_data_changed)
        layout.addWidget(self.table)

        # KONTROLLER
        quick_layout = QHBoxLayout()
        self.inp_quick_name = QLineEdit(); self.inp_quick_name.setPlaceholderText(tr("HEADER_NAME"))
        self.inp_quick_init = QLineEdit(); self.inp_quick_init.setPlaceholderText(tr("LBL_INIT")); self.inp_quick_init.setMaximumWidth(50)
        self.inp_quick_hp = QLineEdit(); self.inp_quick_hp.setPlaceholderText(tr("LBL_HP")); self.inp_quick_hp.setMaximumWidth(50)
        self.btn_quick_add = QPushButton(tr("BTN_QUICK_ADD")); self.btn_quick_add.clicked.connect(self.quick_add)
        
        quick_layout.addWidget(self.inp_quick_name, 3)
        quick_layout.addWidget(self.inp_quick_init, 1)
        quick_layout.addWidget(self.inp_quick_hp, 1)
        quick_layout.addWidget(self.btn_quick_add, 1)
        layout.addLayout(quick_layout)

        # Butonlar 1
        btn_layout = QHBoxLayout()
        self.btn_next_turn = QPushButton(tr("BTN_NEXT_TURN"))
        self.btn_next_turn.setStyleSheet("background-color: #fbc02d; color: black; font-weight: bold;")
        self.btn_next_turn.clicked.connect(self.next_turn)
        
        self.btn_battle_map = QPushButton("üó∫Ô∏è Battle Map")
        self.btn_battle_map.setStyleSheet("background-color: #0277bd; color: white; font-weight: bold;")
        self.btn_battle_map.clicked.connect(self.open_battle_map)

        btn_layout.addWidget(self.btn_next_turn)
        btn_layout.addWidget(self.btn_battle_map)
        layout.addLayout(btn_layout)
        
        # Butonlar 2
        btn_layout2 = QHBoxLayout()
        self.btn_add = QPushButton(tr("BTN_ADD")); self.btn_add.clicked.connect(self.add_combatant_dialog)
        self.btn_add_players = QPushButton(tr("BTN_ADD_PLAYERS")); self.btn_add_players.clicked.connect(self.add_all_players)
        self.btn_roll = QPushButton(tr("BTN_ROLL_INIT")); self.btn_roll.clicked.connect(self.roll_initiatives)
        self.btn_clear_all = QPushButton(tr("BTN_CLEAR_ALL"))
        self.btn_clear_all.clicked.connect(self.clear_tracker)
        self.btn_clear_all.setStyleSheet("color: #ff5252;")
        
        btn_layout2.addWidget(self.btn_add)
        btn_layout2.addWidget(self.btn_add_players)
        btn_layout2.addWidget(self.btn_roll)
        btn_layout2.addWidget(self.btn_clear_all)
        layout.addLayout(btn_layout2)

    # --- BATTLE MAP ENTEGRASYONU (G√úNCELLENDƒ∞) ---
    def open_battle_map(self):
        # 1. Eƒüer pencere zaten a√ßƒ±ksa √∂ne getir
        if self.battle_map_window and self.battle_map_window.isVisible():
            self.battle_map_window.raise_()
            self.battle_map_window.activateWindow()
            return

        force_reload = False
        
        # 2. Eƒüer harita yolu yoksa SE√áƒ∞M EKRANINI A√á
        if not self.current_map_path:
            # Assets klas√∂r√ºn√º bul
            assets_path = os.path.join(self.dm.current_campaign_path, "assets")
            if not os.path.exists(assets_path):
                os.makedirs(assets_path)
            
            # Se√ßim diyaloƒüunu a√ß
            selector = MapSelectorDialog(assets_path, self)
            
            if selector.exec():
                if selector.is_new_import:
                    # Yeni Y√ºkle
                    fname, _ = QFileDialog.getOpenFileName(self, "Yeni Harita Se√ß", "", "Images (*.png *.jpg *.jpeg)")
                    if fname:
                        rel_path = self.dm.import_image(fname)
                        if rel_path:
                            self.current_map_path = rel_path
                            force_reload = True
                            self.data_changed_signal.emit()
                    else:
                        return # ƒ∞ptal ettiyse a√ßma
                elif selector.selected_file:
                    # Mevcut Olanƒ± Se√ß
                    self.current_map_path = os.path.join("assets", selector.selected_file)
                    force_reload = True
                    self.data_changed_signal.emit()
            else:
                return # Diyalog kapatƒ±ldƒ±ysa harita a√ßma

        # 3. Pencereyi Olu≈ütur ve G√∂ster
        self.battle_map_window = BattleMapWindow(self.dm)
        self.battle_map_window.token_moved_signal.connect(self.on_token_moved_in_map)
        self.battle_map_window.slider_size.valueChanged.connect(self.on_token_size_changed)
        
        self.battle_map_window.show()
        
        self.refresh_battle_map(force_map_reload=force_reload)

    def on_token_moved_in_map(self, eid, x, y):
        self.token_positions[eid] = (x, y)
        self.data_changed_signal.emit() # Pozisyon deƒüi≈üince kaydet

    def on_token_size_changed(self, val):
        self.current_token_size = val
        self.data_changed_signal.emit() # Boyut deƒüi≈üince kaydet

    def refresh_battle_map(self, force_map_reload=False):
        if not self.battle_map_window or not self.battle_map_window.isVisible(): return
        
        data = self.get_combat_data_for_map()
        
        # Harita yolu (relative -> full)
        map_full_path = None
        # Eƒüer force_map_reload istenmi≈üse VEYA pencerede harita hi√ß yoksa g√∂nder
        if (force_map_reload or self.battle_map_window.map_item is None) and self.current_map_path:
            map_full_path = self.dm.get_full_path(self.current_map_path)
        
        self.battle_map_window.update_combat_data(data, self.current_turn_index, map_full_path, self.current_token_size)

    def get_combat_data_for_map(self):
        data = []
        for row in range(self.table.rowCount()):
            item_init = self.table.item(row, 1)
            # G√ºvenlik kontrol√º
            if not item_init: continue
            
            eid = item_init.data(Qt.ItemDataRole.UserRole)
            x, y = None, None
            if eid and eid in self.token_positions:
                x, y = self.token_positions[eid]
            
            data.append({
                "name": self.table.item(row, 0).text(),
                "hp": self.table.item(row, 3).text(),
                "eid": eid,
                "x": x, "y": y
            })
        return data

    def on_data_changed(self, item): 
        self.refresh_battle_map()
        self.data_changed_signal.emit()

    # --- SAVA≈û AKI≈ûI ---
    def next_turn(self):
        count = self.table.rowCount()
        if count == 0: return
        self.current_turn_index = (self.current_turn_index + 1) % count
        self.update_highlights()
        self.refresh_battle_map()
        self.data_changed_signal.emit()

    def update_highlights(self):
        for r in range(self.table.rowCount()):
            for c in range(self.table.columnCount()):
                item = self.table.item(r, c)
                if item: item.setBackground(QBrush(QColor(0,0,0,0)))
        if 0 <= self.current_turn_index < self.table.rowCount():
            for c in range(self.table.columnCount()):
                item = self.table.item(self.current_turn_index, c)
                if item: item.setBackground(QBrush(QColor(40, 80, 40)))

    def _sort_and_refresh(self):
        self.table.sortItems(1, Qt.SortOrder.DescendingOrder)
        self.current_turn_index = -1 
        self.update_highlights()
        self.refresh_battle_map()
        self.data_changed_signal.emit()

    def clear_tracker(self):
        self.table.setRowCount(0)
        self.current_turn_index = -1
        self.token_positions.clear()
        self.current_map_path = None
        self.refresh_battle_map()
        if self.battle_map_window: self.battle_map_window.set_map_image(None)
        self.data_changed_signal.emit()

    # --- SAVE / LOAD Sƒ∞STEMƒ∞ ---
    def get_session_state(self):
        """Oturum kaydedilirken √ßaƒürƒ±lƒ±r. T√ºm durumu paketler."""
        combatants = []
        for row in range(self.table.rowCount()):
            # H√úCRE G√úVENLƒ∞ƒûƒ∞
            item_name = self.table.item(row, 0)
            item_init = self.table.item(row, 1)
            item_ac = self.table.item(row, 2)
            item_hp = self.table.item(row, 3)
            item_cond = self.table.item(row, 4)

            if item_name is None or item_init is None: continue

            eid = item_init.data(Qt.ItemDataRole.UserRole)
            x, y = None, None
            if eid and eid in self.token_positions: x, y = self.token_positions[eid]

            combatants.append({
                "name": item_name.text(),
                "init": item_init.text(),
                "ac": item_ac.text() if item_ac else "",
                "hp": item_hp.text() if item_hp else "",
                "cond": item_cond.text() if item_cond else "",
                "eid": eid,
                "bonus": item_name.data(Qt.ItemDataRole.UserRole),
                "x": x, "y": y
            })
            
        return {
            "combatants": combatants,
            "map_path": self.current_map_path, 
            "token_size": self.current_token_size,
            "turn_index": self.current_turn_index
        }

    def load_session_state(self, state_data):
        self.table.blockSignals(True)
        self.table.setRowCount(0)
        self.token_positions.clear()
        
        combatants = state_data.get("combatants", [])
        self.current_map_path = state_data.get("map_path")
        self.current_token_size = state_data.get("token_size", 50)
        self.current_turn_index = state_data.get("turn_index", -1)
        
        for c in combatants:
            eid = c.get("eid")
            if eid and "x" in c and c["x"] is not None:
                self.token_positions[eid] = (c["x"], c["y"])
            self.add_direct_row(c["name"], c["init"], c["ac"], c["hp"], c["cond"], eid, c.get("bonus", 0))
            
        self.table.blockSignals(False)
        self._sort_and_refresh()
        
        if self.current_map_path:
             self.open_battle_map()

    # --- HELPER METHODS ---
    def add_direct_row(self, name, init, ac, hp, condition, eid, init_bonus=0):
        row = self.table.rowCount(); self.table.insertRow(row)
        item_name = QTableWidgetItem(name); item_name.setData(Qt.ItemDataRole.UserRole, init_bonus); self.table.setItem(row, 0, item_name)
        item_init = QTableWidgetItem(); item_init.setData(Qt.ItemDataRole.DisplayRole, str(init)); item_init.setData(Qt.ItemDataRole.EditRole, int(init) if str(init).isdigit() else 0); item_init.setData(Qt.ItemDataRole.UserRole, eid); self.table.setItem(row, 1, item_init)
        self.table.setItem(row, 2, QTableWidgetItem(str(ac))); self.table.setItem(row, 3, QTableWidgetItem(str(hp)))
        cond_item = QTableWidgetItem(condition); cond_item.setForeground(QBrush(QColor("#ff5252"))) if condition else None; self.table.setItem(row, 4, cond_item)

    def quick_add(self):
        name = self.inp_quick_name.text().strip(); 
        if not name: return
        self.add_direct_row(name, self.inp_quick_init.text() or str(random.randint(1,20)), "10", self.inp_quick_hp.text() or "10", "", None)
        self.inp_quick_name.clear(); self.inp_quick_init.clear(); self.inp_quick_hp.clear()
        self._sort_and_refresh()

    def add_combatant_dialog(self):
        entities = self.dm.data["entities"]
        items = []; ids = []
        for eid, data in entities.items():
            if data.get("type") in ["NPC", "Canavar", "Oyuncu"]:
                items.append(f"{data['name']} ({data['type']})"); ids.append(eid)
        item, ok = QInputDialog.getItem(self, tr("BTN_ADD"), tr("LBL_NAME"), items, 0, False)
        if ok and item: self.add_row_from_entity(ids[items.index(item)]); self._sort_and_refresh()

    def add_row_from_entity(self, entity_id):
        data = self.dm.data["entities"].get(entity_id)
        if not data: return
        name = data.get("name", "Bilinmeyen")
        hp = data.get("combat_stats", {}).get("hp", "10")
        ac = data.get("combat_stats", {}).get("ac", "10")
        try: dex = int(data.get("stats", {}).get("DEX", 10)); dex_mod = (dex - 10) // 2
        except: dex_mod = 0
        roll = random.randint(1, 20) + dex_mod
        self.add_direct_row(name, roll, ac, hp, "", entity_id, dex_mod)

    def add_all_players(self):
        existing_eids = [self.table.item(row, 1).data(Qt.ItemDataRole.UserRole) for row in range(self.table.rowCount())]
        for eid, data in self.dm.data["entities"].items():
            if data.get("type") == "Oyuncu" and eid not in existing_eids: self.add_row_from_entity(eid)
        self._sort_and_refresh()

    def roll_initiatives(self):
        self.table.blockSignals(True)
        for row in range(self.table.rowCount()):
            item = self.table.item(row, 1); bonus = self.table.item(row, 0).data(Qt.ItemDataRole.UserRole) or 0
            roll = random.randint(1, 20) + bonus
            item.setData(Qt.ItemDataRole.DisplayRole, str(roll)); item.setData(Qt.ItemDataRole.EditRole, roll)
        self.table.blockSignals(False)
        self._sort_and_refresh()

    def open_context_menu(self, position):
        row = self.table.rowAt(position.y()); 
        if row == -1: return
        menu = QMenu()
        cond_menu = menu.addMenu(tr("MENU_ADD_COND"))
        current_cond_text = self.table.item(row, 4).text()
        current_conditions = [c.strip() for c in current_cond_text.split(",") if c.strip()]
        for cond in CONDITIONS:
            action = QAction(cond, self); action.setCheckable(True)
            if any(cond.split(" ")[0] in c for c in current_conditions): action.setChecked(True)
            action.triggered.connect(lambda checked, c=cond, r=row: self.toggle_condition(r, c))
            cond_menu.addAction(action)
        menu.addSeparator()
        del_action = QAction(tr("MENU_REMOVE_COMBAT"), self)
        del_action.triggered.connect(lambda: self.delete_row(row))
        menu.addAction(del_action)
        menu.exec(self.table.viewport().mapToGlobal(position))
        self.refresh_battle_map()

    def toggle_condition(self, row, condition):
        item = self.table.item(row, 4)
        current_list = [c.strip() for c in item.text().split(",") if c.strip()]
        if condition in current_list: current_list.remove(condition)
        else: current_list.append(condition)
        new_text = ", ".join(current_list)
        item.setText(new_text)
        item.setForeground(QBrush(QColor("#ff5252"))) if new_text else item.setForeground(QBrush(QColor("#e0e0e0")))
        self.refresh_battle_map()
        self.data_changed_signal.emit()

    def delete_row(self, row):
        self.table.removeRow(row)
        if self.table.rowCount() > 0:
            if self.current_turn_index >= row:
                self.current_turn_index = max(0, self.current_turn_index - 1)
        else:
            self.current_turn_index = -1
        self.update_highlights()
        self.refresh_battle_map()
        self.data_changed_signal.emit()

--------------------------------------------------
Path: ui/widgets/map_viewer.py
--------------------------------------------------
from PyQt6.QtWidgets import QGraphicsView, QGraphicsScene, QGraphicsPixmapItem, QGraphicsEllipseItem, QMenu, QGraphicsItem
from PyQt6.QtGui import QPixmap, QBrush, QColor, QPen, QAction, QPainter, QWheelEvent, QCursor
from PyQt6.QtCore import Qt, pyqtSignal

class MapPinItem(QGraphicsEllipseItem):
    def __init__(self, x, y, radius, color, pin_id, entity_id, tooltip_text, callback_action):
        super().__init__(x - radius/2, y - radius/2, radius, radius)
        self.pin_id = pin_id
        self.entity_id = entity_id
        self.callback_action = callback_action # (action_type, pin_obj) -> Fonksiyon
        
        self.setBrush(QBrush(QColor(color)))
        pen = QPen(Qt.GlobalColor.white)
        pen.setWidth(2)
        self.setPen(pen)
        
        self.setToolTip(tooltip_text)
        self.setZValue(10)
        self.setCursor(Qt.CursorShape.PointingHandCursor)
        self.setFlags(QGraphicsItem.GraphicsItemFlag.ItemIsSelectable)

    def mousePressEvent(self, event):
        if event.button() == Qt.MouseButton.LeftButton:
            # Sol tƒ±k men√ºs√º
            menu = QMenu()
            menu.setStyleSheet("QMenu { background-color: #333; color: white; border: 1px solid #555; } QMenu::item:selected { background-color: #007acc; }")
            
            act_inspect = QAction("üîç ƒ∞ncele", menu)
            act_move = QAction("‚úã Ta≈üƒ±", menu)
            act_delete = QAction("üóëÔ∏è Sil", menu)
            
            menu.addAction(act_inspect)
            menu.addAction(act_move)
            menu.addSeparator()
            menu.addAction(act_delete)
            
            selected = menu.exec(QCursor.pos())
            
            if selected == act_inspect: self.callback_action("inspect", self)
            elif selected == act_move: self.callback_action("move", self)
            elif selected == act_delete: self.callback_action("delete", self)
                
            event.accept()
        else:
            super().mousePressEvent(event)

class MapViewer(QGraphicsView):
    pin_created_signal = pyqtSignal(float, float)
    pin_moved_signal = pyqtSignal(str, float, float) # id, new_x, new_y

    def __init__(self, parent=None):
        super().__init__(parent)
        self.scene = QGraphicsScene(self)
        self.setScene(self.scene)
        self.setRenderHint(QPainter.RenderHint.Antialiasing)
        self.setRenderHint(QPainter.RenderHint.SmoothPixmapTransform)
        self.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)
        self.setTransformationAnchor(QGraphicsView.ViewportAnchor.AnchorUnderMouse)
        self.setBackgroundBrush(QBrush(QColor("#111")))
        
        self.map_item = None
        self.is_moving_pin = False
        self.moving_pin_id = None

    def load_map(self, pixmap):
        self.scene.clear()
        self.map_item = QGraphicsPixmapItem(pixmap)
        self.map_item.setTransformationMode(Qt.TransformationMode.SmoothTransformation)
        self.map_item.setZValue(0)
        self.scene.addItem(self.map_item)
        self.setSceneRect(self.map_item.boundingRect())
        self.cancel_move_mode()

    def add_pin_object(self, pin_item):
        self.scene.addItem(pin_item)

    def start_move_mode(self, pin_id):
        self.is_moving_pin = True
        self.moving_pin_id = pin_id
        self.viewport().setCursor(Qt.CursorShape.CrossCursor)
        self.setDragMode(QGraphicsView.DragMode.NoDrag)

    def cancel_move_mode(self):
        self.is_moving_pin = False
        self.moving_pin_id = None
        self.viewport().setCursor(Qt.CursorShape.ArrowCursor)
        self.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)

    def mousePressEvent(self, event):
        if self.is_moving_pin and event.button() == Qt.MouseButton.LeftButton:
            scene_pos = self.mapToScene(event.pos())
            if self.map_item and self.map_item.boundingRect().contains(scene_pos):
                self.pin_moved_signal.emit(self.moving_pin_id, scene_pos.x(), scene_pos.y())
                self.cancel_move_mode()
                return
        super().mousePressEvent(event)

    def wheelEvent(self, event: QWheelEvent):
        zoom_in = 1.15
        zoom_out = 1 / zoom_in
        if event.angleDelta().y() > 0: self.scale(zoom_in, zoom_in)
        else: self.scale(zoom_out, zoom_out)

    def contextMenuEvent(self, event):
        if self.is_moving_pin:
            self.cancel_move_mode()
            return

        if not self.map_item: return
        menu = QMenu(self)
        menu.setStyleSheet("QMenu { background-color: #333; color: white; border: 1px solid #555; } QMenu::item:selected { background-color: #007acc; }")
        
        action_add_pin = QAction("üìç Buraya Pin Ekle", self)
        menu.addAction(action_add_pin)
        
        scene_pos = self.mapToScene(event.pos())
        if not self.map_item.boundingRect().contains(scene_pos): return
        
        action = menu.exec(event.globalPos())
        if action == action_add_pin:
            self.pin_created_signal.emit(scene_pos.x(), scene_pos.y())

--------------------------------------------------
Path: ui/widgets/npc_sheet.py
--------------------------------------------------
from PyQt6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QFormLayout, 
                             QLineEdit, QTextEdit, QComboBox, QTabWidget, 
                             QLabel, QGroupBox, QPushButton, QScrollArea, QFrame, 
                             QListWidget, QFileDialog, QMessageBox, QStyle)
from PyQt6.QtCore import Qt, QUrl
from PyQt6.QtGui import QDesktopServices, QPixmap
from ui.widgets.aspect_ratio_label import AspectRatioLabel
from core.models import ENTITY_SCHEMAS
from core.locales import tr
import os

class NpcSheet(QWidget):
    def __init__(self):
        super().__init__()
        self.dynamic_inputs = {}
        self.image_list = []
        self.current_img_index = 0
        self.init_ui()

    def init_ui(self):
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)

        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setFrameShape(QFrame.Shape.NoFrame)
        
        self.content_widget = QWidget()
        self.content_layout = QVBoxLayout(self.content_widget)

        # --- √úST B√ñL√úM (RESƒ∞M & TEMEL Bƒ∞LGƒ∞) ---
        top_layout = QHBoxLayout()
        img_layout = QVBoxLayout()
        self.lbl_image = AspectRatioLabel()
        self.lbl_image.setFixedSize(200, 200)
        
        # Galeri Kontrolleri
        gallery_controls = QHBoxLayout()
        self.btn_prev_img = QPushButton()
        self.btn_prev_img.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_ArrowBack))
        self.btn_prev_img.setMaximumWidth(30)
        
        self.btn_next_img = QPushButton()
        self.btn_next_img.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_ArrowForward))
        self.btn_next_img.setMaximumWidth(30)
        
        self.lbl_img_counter = QLabel("0/0")
        self.lbl_img_counter.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        gallery_controls.addWidget(self.btn_prev_img)
        gallery_controls.addWidget(self.lbl_img_counter)
        gallery_controls.addWidget(self.btn_next_img)
        
        btn_img_actions = QHBoxLayout()
        self.btn_add_img = QPushButton("Ekle")
        self.btn_add_img.setObjectName("successBtn")
        
        self.btn_remove_img = QPushButton()
        self.btn_remove_img.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_TrashIcon))
        self.btn_remove_img.setObjectName("dangerBtn")
        
        btn_img_actions.addWidget(self.btn_add_img)
        btn_img_actions.addWidget(self.btn_remove_img)

        self.btn_show_player = QPushButton(tr("BTN_SHOW_PLAYER"))
        self.btn_show_player.setObjectName("primaryBtn")
        
        img_layout.addWidget(self.lbl_image)
        img_layout.addLayout(gallery_controls)
        img_layout.addLayout(btn_img_actions)
        img_layout.addWidget(self.btn_show_player)
        img_layout.addStretch()

        info_layout = QFormLayout()
        self.inp_name = QLineEdit()
        self.inp_type = QComboBox()
        self.inp_type.addItems(list(ENTITY_SCHEMAS.keys()))
        self.inp_type.currentTextChanged.connect(self.update_ui_by_type)
        self.inp_tags = QLineEdit(); self.inp_tags.setPlaceholderText("boss, undead, merchant...")
        
        self.combo_location = QComboBox()
        self.lbl_location = QLabel(tr("LBL_LOCATION"))
        self.list_residents = QListWidget(); self.list_residents.setMaximumHeight(80)
        self.lbl_residents = QLabel(tr("LBL_RESIDENTS"))
        
        # --- G√úNCELLEME: Ana a√ßƒ±klama kutusunu da b√ºy√ºtt√ºk ---
        self.inp_desc = QTextEdit()
        self.inp_desc.setMinimumHeight(80)  # Min 80px (yakla≈üƒ±k 4 satƒ±r)
        self.inp_desc.setMaximumHeight(150)
        self.inp_desc.setPlaceholderText(tr("LBL_DESC"))

        info_layout.addRow(tr("LBL_NAME"), self.inp_name)
        info_layout.addRow(tr("LBL_TYPE"), self.inp_type)
        info_layout.addRow(tr("LBL_TAGS"), self.inp_tags)
        info_layout.addRow(self.lbl_location, self.combo_location)
        info_layout.addRow(self.lbl_residents, self.list_residents)
        info_layout.addRow(tr("LBL_DESC"), self.inp_desc)

        top_layout.addLayout(img_layout); top_layout.addLayout(info_layout)
        self.content_layout.addLayout(top_layout)

        # --- Dƒ∞NAMƒ∞K ALANLAR ---
        self.grp_dynamic = QGroupBox("√ñzellikler")
        self.layout_dynamic = QFormLayout(self.grp_dynamic)
        self.content_layout.addWidget(self.grp_dynamic)

        # --- SEKMELER ---
        self.tabs = QTabWidget()
        self.tab_stats = QWidget(); self.setup_stats_tab(); self.tabs.addTab(self.tab_stats, tr("TAB_STATS"))
        self.tab_spells = QWidget(); self.setup_spells_tab(); self.tabs.addTab(self.tab_spells, tr("TAB_SPELLS"))
        self.tab_features = QWidget(); self.setup_features_tab(); self.tabs.addTab(self.tab_features, tr("TAB_ACTIONS"))
        self.tab_inventory = QWidget(); self.setup_inventory_tab(); self.tabs.addTab(self.tab_inventory, tr("TAB_INV"))
        self.tab_docs = QWidget(); self.setup_docs_tab(); self.tabs.addTab(self.tab_docs, tr("TAB_DOCS"))

        self.content_layout.addWidget(self.tabs)
        scroll.setWidget(self.content_widget)
        main_layout.addWidget(scroll)

        # --- BUTONLAR ---
        btn_layout = QHBoxLayout(); btn_layout.setContentsMargins(10, 10, 10, 10)
        self.btn_delete = QPushButton(tr("BTN_DELETE")); self.btn_delete.setObjectName("dangerBtn")
        self.btn_save = QPushButton(tr("BTN_SAVE")); self.btn_save.setObjectName("primaryBtn")
        btn_layout.addStretch(); btn_layout.addWidget(self.btn_delete); btn_layout.addWidget(self.btn_save)
        main_layout.addLayout(btn_layout)
        
        self.update_ui_by_type(self.inp_type.currentText())

    # --- TAB KURULUMLARI ---
    def setup_stats_tab(self):
        layout = QVBoxLayout(self.tab_stats)
        
        # Base Stats
        grp = QGroupBox(tr("GRP_STATS")); l = QHBoxLayout(grp)
        self.stats_inputs = {}; self.stats_modifiers = {}
        for s in ["STR", "DEX", "CON", "INT", "WIS", "CHA"]:
            v = QVBoxLayout()
            lbl_title = QLabel(s); lbl_title.setAlignment(Qt.AlignmentFlag.AlignCenter); lbl_title.setStyleSheet("font-weight: bold;")
            inp = QLineEdit("10"); inp.setAlignment(Qt.AlignmentFlag.AlignCenter); inp.setMaximumWidth(50)
            inp.textChanged.connect(lambda text, key=s: self._update_modifier(key, text))
            lbl_mod = QLabel("+0"); lbl_mod.setAlignment(Qt.AlignmentFlag.AlignCenter); lbl_mod.setStyleSheet("color: #aaa; font-size: 11px;")
            self.stats_inputs[s] = inp; self.stats_modifiers[s] = lbl_mod
            v.addWidget(lbl_title); v.addWidget(inp); v.addWidget(lbl_mod); l.addLayout(v)
        layout.addWidget(grp)
        
        # Combat Stats
        self.grp_combat_stats = self._create_combat_stats_group()
        layout.addWidget(self.grp_combat_stats)

        # Extended Stats
        grp3 = QGroupBox(tr("GRP_DEFENSE")); form3 = QFormLayout(grp3)
        self.inp_saves = QLineEdit(); self.inp_skills = QLineEdit()
        self.inp_vuln = QLineEdit(); self.inp_resist = QLineEdit()
        self.inp_dmg_immune = QLineEdit(); self.inp_cond_immune = QLineEdit()
        form3.addRow(tr("LBL_SAVES"), self.inp_saves); form3.addRow(tr("LBL_SKILLS"), self.inp_skills)
        form3.addRow(tr("LBL_VULN"), self.inp_vuln); form3.addRow(tr("LBL_RESIST"), self.inp_resist)
        form3.addRow(tr("LBL_DMG_IMMUNE"), self.inp_dmg_immune); form3.addRow(tr("LBL_COND_IMMUNE"), self.inp_cond_immune)
        layout.addWidget(grp3); layout.addStretch()
        
    def _create_combat_stats_group(self):
        grp = QGroupBox(tr("GRP_COMBAT"))
        v_comb = QVBoxLayout(grp)
        self.inp_hp = QLineEdit(); self.inp_hp.setPlaceholderText(tr("LBL_HP"))
        self.inp_max_hp = QLineEdit(); self.inp_max_hp.setPlaceholderText("Max HP")
        self.inp_ac = QLineEdit(); self.inp_ac.setPlaceholderText(tr("HEADER_AC"))
        self.inp_speed = QLineEdit(); self.inp_prof = QLineEdit(); self.inp_pp = QLineEdit()
        self.inp_init = QLineEdit(); self.inp_init.setPlaceholderText(tr("LBL_INIT"))
        
        row1 = QHBoxLayout()
        for t, w in [("Max HP", self.inp_max_hp), (tr("LBL_HP"), self.inp_hp), (tr("HEADER_AC"), self.inp_ac), ("Hƒ±z", self.inp_speed)]:
             v = QVBoxLayout(); v.addWidget(QLabel(t)); v.addWidget(w); row1.addLayout(v)
        
        row2 = QHBoxLayout()
        for t, w in [(tr("LBL_PROF_BONUS"), self.inp_prof), (tr("LBL_PASSIVE_PERC"), self.inp_pp), (tr("LBL_INIT_BONUS"), self.inp_init)]:
             v = QVBoxLayout(); v.addWidget(QLabel(t)); v.addWidget(w); row2.addLayout(v)
             
        v_comb.addLayout(row1); v_comb.addLayout(row2)
        return grp

    def _update_modifier(self, stat_key, text_value):
        try:
            val = int(text_value); mod = (val - 10) // 2; sign = "+" if mod >= 0 else ""
            self.stats_modifiers[stat_key].setText(f"{sign}{mod}")
            self.stats_modifiers[stat_key].setStyleSheet(f"color: {'#4caf50' if mod > 0 else '#aaa'}; font-size: 11px; font-weight: bold;")
        except ValueError:
            self.stats_modifiers[stat_key].setText("-")

    def setup_spells_tab(self):
        layout = QVBoxLayout(self.tab_spells)
        
        # Linked Spells
        grp_linked = QGroupBox(tr("GRP_SPELLS"))
        l_linked = QVBoxLayout(grp_linked)
        h = QHBoxLayout()
        self.combo_all_spells = QComboBox(); self.combo_all_spells.setEditable(True); self.combo_all_spells.setPlaceholderText(tr("LBL_SEARCH"))
        self.btn_add_spell = QPushButton(tr("BTN_ADD")); self.btn_add_spell.setObjectName("successBtn")
        h.addWidget(self.combo_all_spells, 3); h.addWidget(self.btn_add_spell, 1)
        
        self.list_assigned_spells = QListWidget()
        self.list_assigned_spells.setAlternatingRowColors(True)
        self.list_assigned_spells.setMinimumHeight(300)
        self.list_assigned_spells.setAlternatingRowColors(True)
        self.list_assigned_spells.setStyleSheet("QListWidget::item { border-bottom: 1px solid #333; padding: 2px; } QListWidget::item:selected { border: 1px solid #7c4dff; }")

        self.btn_remove_spell = QPushButton(tr("BTN_REMOVE"))
        self.btn_remove_spell.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_TrashIcon))
        
        l_linked.addLayout(h); l_linked.addWidget(self.list_assigned_spells); l_linked.addWidget(self.btn_remove_spell)
        layout.addWidget(grp_linked)
        
        # Manual Spells
        self.custom_spell_container = self._create_section("Manual Spells")
        self.add_btn_to_section(self.custom_spell_container, tr("BTN_ADD"))
        layout.addWidget(self.custom_spell_container); layout.addStretch()

    def setup_features_tab(self):
        layout = QVBoxLayout(self.tab_features)
        self.trait_container = self._create_section("Traits"); self.add_btn_to_section(self.trait_container, tr("BTN_ADD"))
        self.action_container = self._create_section("Actions"); self.add_btn_to_section(self.action_container, tr("BTN_ADD"))
        self.reaction_container = self._create_section("Reactions"); self.add_btn_to_section(self.reaction_container, tr("BTN_ADD"))
        self.legendary_container = self._create_section("Legendary Actions"); self.add_btn_to_section(self.legendary_container, tr("BTN_ADD"))
        layout.addWidget(self.trait_container); layout.addWidget(self.action_container)
        layout.addWidget(self.reaction_container); layout.addWidget(self.legendary_container); layout.addStretch()

    def setup_inventory_tab(self):
        layout = QVBoxLayout(self.tab_inventory)
        
        # Linked Items
        grp_linked = QGroupBox("Veritabanƒ± E≈üyalarƒ±"); l_linked = QVBoxLayout(grp_linked); h = QHBoxLayout()
        self.combo_all_items = QComboBox(); self.combo_all_items.setEditable(True)
        self.btn_add_item_link = QPushButton(tr("BTN_ADD")); self.btn_add_item_link.setObjectName("successBtn")
        h.addWidget(self.combo_all_items, 3); h.addWidget(self.btn_add_item_link, 1)
        
        self.list_assigned_items = QListWidget(); self.list_assigned_items.setAlternatingRowColors(True)
        self.btn_remove_item_link = QPushButton(tr("BTN_REMOVE"))
        self.btn_remove_item_link.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_TrashIcon))
        
        l_linked.addLayout(h); l_linked.addWidget(self.list_assigned_items); l_linked.addWidget(self.btn_remove_item_link)
        layout.addWidget(grp_linked)
        
        # Manual Inventory
        self.inventory_container = self._create_section(tr("GRP_INVENTORY"))
        self.add_btn_to_section(self.inventory_container, tr("BTN_ADD"))
        layout.addWidget(self.inventory_container); layout.addStretch()

    def setup_docs_tab(self):
        layout = QVBoxLayout(self.tab_docs)
        grp = QGroupBox(tr("GRP_PDF")); v = QVBoxLayout(grp)
        h_btn = QHBoxLayout()
        self.btn_add_pdf = QPushButton(tr("BTN_ADD")); self.btn_add_pdf.setObjectName("successBtn")
        self.btn_open_pdf_folder = QPushButton(); self.btn_open_pdf_folder.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_DirIcon))
        h_btn.addWidget(self.btn_add_pdf, 3); h_btn.addWidget(self.btn_open_pdf_folder, 1)
        v.addLayout(h_btn)
        
        self.list_pdfs = QListWidget(); self.list_pdfs.setAlternatingRowColors(True)
        v.addWidget(self.list_pdfs)
        
        h_action = QHBoxLayout()
        self.btn_open_pdf = QPushButton(tr("BTN_OPEN_PDF")); self.btn_open_pdf.setObjectName("primaryBtn")
        self.btn_project_pdf = QPushButton(tr("BTN_PROJECT_PDF")); self.btn_project_pdf.setStyleSheet("background-color: #6a1b9a; color: white;")
        self.btn_remove_pdf = QPushButton(tr("BTN_REMOVE"))
        self.btn_remove_pdf.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_TrashIcon))
        
        h_action.addWidget(self.btn_open_pdf); h_action.addWidget(self.btn_project_pdf); h_action.addWidget(self.btn_remove_pdf)
        v.addLayout(h_action); layout.addWidget(grp); layout.addStretch()

    # --- YARDIMCILAR ---
    def _create_section(self, title):
        group = QGroupBox(title); v = QVBoxLayout(group); group.dynamic_area = QVBoxLayout(); v.addLayout(group.dynamic_area); return group

    def add_btn_to_section(self, container, label):
        btn = QPushButton(label); btn.clicked.connect(lambda: self.add_feature_card(container))
        container.layout().insertWidget(0, btn)

    def add_feature_card(self, group, name="", desc="", ph_title="Ba≈ülƒ±k", ph_desc="Detaylar..."):
        card = QFrame(); card.setStyleSheet("background-color: #2b2b2b; border: 1px solid #444; border-radius: 4px; margin-bottom: 4px;")
        l = QVBoxLayout(card); h = QHBoxLayout()
        
        t = QLineEdit(name); t.setPlaceholderText(ph_title); t.setStyleSheet("color: orange; font-weight: bold; border:none; font-size: 14px;")
        
        # --- Sƒ∞LME BUTONU (STANDART ƒ∞KON) ---
        btn = QPushButton()
        btn.setFixedSize(24,24)
        btn.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_TitleBarCloseButton))
        btn.setCursor(Qt.CursorShape.PointingHandCursor)
        btn.setToolTip("Kaldƒ±r")
        
        btn.clicked.connect(lambda: [group.dynamic_area.removeWidget(card), card.deleteLater()])
        h.addWidget(t); h.addWidget(btn); l.addLayout(h)
        
        # --- G√úNCELLEME: Y√ºksekliƒüi artƒ±rƒ±ldƒ± ---
        d = QTextEdit(desc)
        d.setPlaceholderText(ph_desc)
        d.setMinimumHeight(80)  # Min 80px (yakla≈üƒ±k 4 satƒ±r)
        d.setMaximumHeight(300) # Esneme payƒ±
        d.setStyleSheet("border:none; color: #ccc;")
        l.addWidget(d)
        
        group.dynamic_area.addWidget(card)
        card.inp_title = t; card.inp_desc = d

    def clear_all_cards(self):
        containers = [self.trait_container, self.action_container, self.reaction_container, self.legendary_container, self.inventory_container, self.custom_spell_container]
        for g in containers:
            while g.dynamic_area.count(): 
                c = g.dynamic_area.takeAt(0)
                if c.widget(): c.widget().deleteLater()

    def build_dynamic_form(self, category_name):
        while self.layout_dynamic.rowCount() > 0: self.layout_dynamic.removeRow(0)
        self.dynamic_inputs = {} 
        schema = ENTITY_SCHEMAS.get(category_name, [])
        self.grp_dynamic.setTitle(f"{category_name} √ñzellikleri")
        for label, dtype, options in schema:
            widget = QComboBox() if dtype == "combo" else QLineEdit()
            if dtype == "combo" and options: widget.addItems(options); widget.setEditable(True)
            self.layout_dynamic.addRow(f"{label}:", widget); self.dynamic_inputs[label] = widget

    def update_ui_by_type(self, category_name):
        self.build_dynamic_form(category_name)
        is_npc_like = category_name in ["NPC", "Canavar"]
        is_player = category_name == "Oyuncu"
        is_lore = category_name == "Lore"
        
        self.lbl_location.setVisible(is_npc_like or is_player); self.combo_location.setVisible(is_npc_like or is_player)
        self.lbl_residents.setVisible(category_name == "Mekan"); self.list_residents.setVisible(category_name == "Mekan")
        
        self.tabs.setTabVisible(0, is_npc_like) # Stats
        self.tabs.setTabVisible(1, is_npc_like) # Spells
        self.tabs.setTabVisible(2, is_npc_like) # Actions
        self.tabs.setTabVisible(3, is_npc_like) # Inv
        
        if is_player:
            if self.grp_combat_stats.parent() == self.tab_stats:
                self.tab_stats.layout().removeWidget(self.grp_combat_stats)
                idx = self.content_layout.indexOf(self.tabs)
                self.content_layout.insertWidget(idx, self.grp_combat_stats)
                self.grp_combat_stats.setVisible(True)
        else:
            if self.grp_combat_stats.parent() != self.tab_stats:
                self.content_layout.removeWidget(self.grp_combat_stats)
                self.tab_stats.layout().insertWidget(1, self.grp_combat_stats)
            self.grp_combat_stats.setVisible(is_npc_like)
        
        self.tabs.setTabVisible(4, is_lore or is_player)

    def prepare_new_entity(self):
        self.inp_name.clear(); self.inp_desc.clear(); self.inp_tags.clear(); self.lbl_image.setPixmap(None)
        self.image_list = []; self.current_img_index = 0; self.lbl_img_counter.setText("0/0") 
        self.clear_all_cards(); self.inp_type.setCurrentIndex(0)
        for i in self.stats_inputs.values(): i.setText("10")
        self.inp_hp.clear(); self.inp_max_hp.clear(); self.inp_ac.clear(); self.list_assigned_spells.clear(); self.list_assigned_items.clear()
        self.inp_prof.clear(); self.inp_pp.clear(); self.inp_skills.clear(); self.inp_init.clear()
        self.inp_saves.clear(); self.inp_vuln.clear(); self.inp_resist.clear(); self.inp_dmg_immune.clear(); self.inp_cond_immune.clear()
        self.combo_location.clear(); self.list_residents.clear(); self.list_pdfs.clear()

--------------------------------------------------
Path: ui/widgets/image_viewer.py
--------------------------------------------------
from PyQt6.QtWidgets import QGraphicsView, QGraphicsScene, QGraphicsPixmapItem
from PyQt6.QtGui import QPainter, QWheelEvent
from PyQt6.QtCore import Qt

class ImageViewer(QGraphicsView):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.scene = QGraphicsScene(self)
        self.setScene(self.scene)
        
        # Kaliteli Render Ayarlarƒ±
        self.setRenderHint(QPainter.RenderHint.Antialiasing)
        self.setRenderHint(QPainter.RenderHint.SmoothPixmapTransform)
        
        # S√ºr√ºkle ve Gez
        self.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)
        self.setTransformationAnchor(QGraphicsView.ViewportAnchor.AnchorUnderMouse)
        self.setResizeAnchor(QGraphicsView.ViewportAnchor.AnchorUnderMouse)
        
        # Arka plan (Siyah/Karanlƒ±k)
        self.setStyleSheet("background-color: #000; border: none;")
        self.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        self.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        
        self.pixmap_item = None

    def set_image(self, pixmap):
        self.scene.clear()
        if pixmap and not pixmap.isNull():
            self.pixmap_item = QGraphicsPixmapItem(pixmap)
            # Kaliteli k√º√ß√ºltme/b√ºy√ºtme modu
            self.pixmap_item.setTransformationMode(Qt.TransformationMode.SmoothTransformation)
            self.scene.addItem(self.pixmap_item)
            self.setSceneRect(self.pixmap_item.boundingRect())
            self.fitInView(self.pixmap_item, Qt.AspectRatioMode.KeepAspectRatio) # ƒ∞lk a√ßƒ±lƒ±≈üta sƒ±ƒüdƒ±r
        else:
            self.pixmap_item = None

    def wheelEvent(self, event: QWheelEvent):
        # Zoom ƒ∞≈ülemi
        zoom_in_factor = 1.15
        zoom_out_factor = 1 / zoom_in_factor

        if event.angleDelta().y() > 0:
            self.scale(zoom_in_factor, zoom_in_factor)
        else:
            self.scale(zoom_out_factor, zoom_out_factor)

--------------------------------------------------
Path: ui/tabs/map_tab.py
--------------------------------------------------
import os
import uuid
from PyQt6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QPushButton, 
                             QFileDialog, QFrame, QMessageBox, QInputDialog)
from PyQt6.QtGui import QPixmap
from ui.widgets.map_viewer import MapViewer, MapPinItem
from core.locales import tr

class MapTab(QWidget):
    def __init__(self, data_manager, player_window, main_window_ref):
        super().__init__()
        self.dm = data_manager
        self.player_window = player_window
        self.main_window_ref = main_window_ref # Veritabanƒ± sekmesine ge√ßi≈ü i√ßin ref
        self.init_ui()

    def init_ui(self):
        layout = QVBoxLayout(self)
        
        # --- Toolbar (Butonlar Burada) ---
        toolbar = QHBoxLayout()
        self.btn_load_map = QPushButton(tr("BTN_LOAD_MAP"))
        self.btn_load_map.clicked.connect(self.upload_map_image)
        
        self.btn_show_map_pl = QPushButton(tr("BTN_PROJECT_MAP"))
        self.btn_show_map_pl.setObjectName("primaryBtn")
        self.btn_show_map_pl.clicked.connect(self.push_map_to_player)
        
        toolbar.addWidget(self.btn_load_map)
        toolbar.addStretch()
        toolbar.addWidget(self.btn_show_map_pl)
        
        # --- Viewer ---
        viewer_frame = QFrame()
        viewer_frame.setStyleSheet("background-color: #111; border: 1px solid #444;")
        v_layout = QVBoxLayout(viewer_frame)
        v_layout.setContentsMargins(0,0,0,0)
        
        self.map_viewer = MapViewer()
        self.map_viewer.setStyleSheet("border: none;")
        self.map_viewer.pin_created_signal.connect(self.handle_new_pin)
        self.map_viewer.pin_moved_signal.connect(self.handle_pin_moved)
        
        v_layout.addWidget(self.map_viewer)
        
        layout.addLayout(toolbar)
        layout.addWidget(viewer_frame)

    def upload_map_image(self):
        fname, _ = QFileDialog.getOpenFileName(self, tr("MSG_SELECT_MAP"), "", "Images (*.png *.jpg *.jpeg)")
        if fname:
            rel = self.dm.import_image(fname)
            self.dm.set_map_image(rel)
            self.render_map()

    def render_map(self):
        path = self.dm.get_full_path(self.dm.data["map_data"].get("image_path"))
        if not path or not os.path.exists(path): return
        
        self.map_viewer.load_map(QPixmap(path))
        
        pins = self.dm.data["map_data"].get("pins", [])
        entities = self.dm.data["entities"]
        
        for pin in pins:
            if pin["entity_id"] in entities:
                ent = entities[pin["entity_id"]]
                color = "#007acc"
                if ent["type"] == "NPC": color = "#ff9800"
                elif ent["type"] == "Mekan": color = "#2e7d32"
                elif ent["type"] == "Canavar": color = "#d32f2f"
                elif ent["type"] == "Oyuncu": color = "#4caf50"
                
                pin_id = pin.get("id")
                if not pin_id: pin_id = str(uuid.uuid4())
                
                pin_item = MapPinItem(pin["x"], pin["y"], 24, color, pin_id, pin["entity_id"], ent["name"], self.on_pin_action)
                self.map_viewer.add_pin_object(pin_item)

    def push_map_to_player(self):
        if self.player_window.isVisible():
            path = self.dm.get_full_path(self.dm.data["map_data"].get("image_path"))
            self.player_window.show_image(QPixmap(path) if path else None)
        else:
            QMessageBox.warning(self, tr("MSG_WARNING"), tr("MSG_NO_PLAYER_SCREEN"))

    def handle_new_pin(self, x, y):
        entities = self.dm.data["entities"]
        if not entities: 
            QMessageBox.warning(self, "Hata", "√ñnce veritabanƒ±na bir varlƒ±k ekleyin.")
            return
            
        items, ids = [], []
        
        # --- Fƒ∞LTRELEME MANTIƒûI ---
        # Haritaya sadece fiziksel olarak bulunabilen ≈üeyler eklensin
        allowed_types = ["NPC", "Canavar", "Oyuncu", "Mekan", "E≈üya", "E≈üya (Equipment)"]
        
        for eid, data in entities.items():
            # Eƒüer varlƒ±ƒüƒ±n tipi izin verilenler listesindeyse listeye ekle
            if data.get("type") in allowed_types:
                items.append(f"{data['name']} ({data['type']})")
                ids.append(eid)
        
        if not items:
            QMessageBox.warning(self, tr("MSG_WARNING"), tr("MSG_NO_ENTITY_FOR_PIN"))
            return
            
        item, ok = QInputDialog.getItem(self, tr("MSG_ADD_PIN"), tr("MSG_SELECT_ENTITY"), items, 0, False)
        if ok and item:
            self.dm.add_pin(x, y, ids[items.index(item)])
            self.render_map()

    def on_pin_action(self, action_type, pin_obj):
        if action_type == "inspect":
            # Ana penceredeki Database tabƒ±na ge√ß ve karakteri y√ºkle
            # Bunun i√ßin main_window referansƒ±na veya signal'e ihtiyacƒ±mƒ±z var.
            # ≈ûimdilik main_window_ref √ºzerinden gidelim.
            if self.main_window_ref:
                self.main_window_ref.tabs.setCurrentIndex(0) # Database tab
                self.main_window_ref.db_tab.load_entity_by_id(pin_obj.entity_id)
                
        elif action_type == "move":
            self.map_viewer.start_move_mode(pin_obj.pin_id)
            
        elif action_type == "delete":
            if QMessageBox.question(self, tr("BTN_DELETE"), tr("MSG_DELETE_PIN")) == QMessageBox.StandardButton.Yes:
                self.dm.remove_specific_pin(pin_obj.pin_id)
                self.render_map()

    def handle_pin_moved(self, pin_id, new_x, new_y):
        self.dm.move_pin(pin_id, new_x, new_y)
        self.render_map()

--------------------------------------------------
Path: ui/tabs/session_tab.py
--------------------------------------------------
from PyQt6.QtWidgets import (QWidget, QHBoxLayout, QVBoxLayout, QTextEdit, 
                             QLabel, QPushButton, QGroupBox, QInputDialog, 
                             QComboBox, QMessageBox)
from PyQt6.QtCore import QDateTime
from core.locales import tr
from ui.widgets.combat_tracker import CombatTracker
import random

class SessionTab(QWidget):
    def __init__(self, data_manager):
        super().__init__()
        self.dm = data_manager
        self.current_session_id = None
        self.init_ui()
        
        # --- UYGULAMA A√áILINCA SON OTURUMU Y√úKLE ---
        last_sid = self.dm.get_last_active_session_id()
        if last_sid:
            # Combo box'ta bul ve se√ß
            idx = self.combo_sessions.findData(last_sid)
            if idx >= 0:
                self.combo_sessions.setCurrentIndex(idx)
                self.load_session() # Otomatik y√ºkle

    def init_ui(self):
        layout = QHBoxLayout(self)

        # --- SOL: SAVA≈û TAKƒ∞P√áƒ∞Sƒ∞ ---
        left_layout = QVBoxLayout()
        self.combat_tracker = CombatTracker(self.dm)
        
        # OTOMATƒ∞K KAYIT BAƒûLANTISI
        # CombatTracker'da veri deƒüi≈üince save_session'ƒ± tetikle
        self.combat_tracker.data_changed_signal.connect(self.auto_save)
        
        left_layout.addWidget(QLabel(tr("TITLE_COMBAT")))
        left_layout.addWidget(self.combat_tracker)
        
        # Zar Paneli
        dice_group = QGroupBox(tr("GRP_DICE"))
        dice_layout = QHBoxLayout(dice_group)
        for d in [4, 6, 8, 10, 12, 20, 100]:
            btn = QPushButton(f"d{d}")
            btn.clicked.connect(lambda checked, x=d: self.roll_dice(x))
            dice_layout.addWidget(btn)
        left_layout.addWidget(dice_group)
        
        # --- SAƒû: NOTLAR & LOG ---
        right_layout = QVBoxLayout()
        
        # Session Se√ßici
        session_control = QHBoxLayout()
        self.combo_sessions = QComboBox()
        self.refresh_session_list()
        
        # Session deƒüi≈üince otomatik y√ºkle (opsiyonel ama kullanƒ±≈ülƒ±)
        # self.combo_sessions.currentIndexChanged.connect(self.load_session) 
        # Ancak kullanƒ±cƒ± yeni olu≈ütururken vs karƒ±≈üabilir, butona bƒ±rakalƒ±m ≈üimdilik.
        
        self.btn_new_session = QPushButton(tr("BTN_NEW_SESSION"))
        self.btn_new_session.clicked.connect(self.new_session)
        
        # Manuel Kayƒ±t Butonu (Auto-save var ama kullanƒ±cƒ±lar basmayƒ± sever)
        self.btn_save_session = QPushButton(tr("BTN_SAVE"))
        self.btn_save_session.clicked.connect(lambda: self.save_session(show_msg=True))
        
        session_control.addWidget(self.combo_sessions, 2)
        session_control.addWidget(self.btn_new_session, 1)
        session_control.addWidget(self.btn_save_session, 1)
        
        self.btn_load_session = QPushButton(tr("BTN_LOAD_SESSION"))
        self.btn_load_session.clicked.connect(self.load_session)
        session_control.addWidget(self.btn_load_session)

        # Log
        self.txt_log = QTextEdit()
        self.txt_log.setPlaceholderText("Olay g√ºnl√ºƒü√º...")
        # Log deƒüi≈üince de kaydet
        self.txt_log.textChanged.connect(self.auto_save)
        
        log_input_layout = QHBoxLayout()
        self.inp_log_entry = QTextEdit()
        self.inp_log_entry.setMaximumHeight(50)
        self.btn_add_log = QPushButton(tr("BTN_ADD_LOG"))
        self.btn_add_log.clicked.connect(self.add_log)
        log_input_layout.addWidget(self.inp_log_entry)
        log_input_layout.addWidget(self.btn_add_log)

        # Notlar
        self.txt_notes = QTextEdit()
        self.txt_notes.setPlaceholderText(tr("LBL_NOTES"))
        # Not deƒüi≈üince de kaydet
        self.txt_notes.textChanged.connect(self.auto_save)

        right_layout.addLayout(session_control)
        right_layout.addWidget(QLabel(tr("LBL_LOG")))
        right_layout.addWidget(self.txt_log)
        right_layout.addLayout(log_input_layout)
        right_layout.addWidget(QLabel(tr("LBL_NOTES")))
        right_layout.addWidget(self.txt_notes)

        layout.addLayout(left_layout, 1)
        layout.addLayout(right_layout, 1)

    # --- FONKSƒ∞YONLAR ---
    def roll_dice(self, sides):
        result = random.randint(1, sides)
        self.log_message(f"üé≤ Rolled d{sides}: {result}")

    def log_message(self, message):
        timestamp = QDateTime.currentDateTime().toString("HH:mm")
        self.txt_log.append(f"[{timestamp}] {message}")

    def add_log(self):
        text = self.inp_log_entry.toPlainText().strip()
        if text:
            self.log_message(text)
            self.inp_log_entry.clear()

    def new_session(self):
        name, ok = QInputDialog.getText(self, "Yeni Oturum", "Oturum Adƒ±:")
        if ok and name:
            sid = self.dm.create_session(name)
            self.refresh_session_list()
            idx = self.combo_sessions.findData(sid)
            if idx >= 0: self.combo_sessions.setCurrentIndex(idx)
            
            self.current_session_id = sid
            self.txt_log.clear()
            self.txt_notes.clear()
            self.combat_tracker.clear_tracker()
            self.log_message(f"Oturum Ba≈üladƒ±: {name}")
            self.save_session(show_msg=False) # ƒ∞lk kaydƒ± yap

    def refresh_session_list(self):
        self.combo_sessions.clear()
        sessions = self.dm.data.get("sessions", [])
        for s in sessions:
            self.combo_sessions.addItem(s["name"], s["id"])

    def load_session(self):
        sid = self.combo_sessions.currentData()
        if not sid: return
        
        session_data = self.dm.get_session(sid)
        if session_data:
            self.current_session_id = sid
            self.dm.set_active_session(sid) # Aktif olarak i≈üaretle
            
            # Notlar ve Loglar
            self.txt_log.blockSignals(True)
            self.txt_notes.blockSignals(True)
            self.txt_log.setHtml(session_data.get("logs", ""))
            self.txt_notes.setText(session_data.get("notes", ""))
            self.txt_log.blockSignals(False)
            self.txt_notes.blockSignals(False)
            
            # Combat State
            combatants_data = session_data.get("combatants", [])
            if isinstance(combatants_data, dict):
                 self.combat_tracker.load_session_state(combatants_data)
            else:
                 self.combat_tracker.load_combat_data(combatants_data)
            
            # Loga yazma (Gereksiz kalabalƒ±k etmesin)
            # self.log_message("Oturum Y√ºklendi.")

    def auto_save(self):
        """Kullanƒ±cƒ±ya mesaj g√∂stermeden sessizce kaydeder."""
        if self.current_session_id:
            self.save_session(show_msg=False)

    def save_session(self, show_msg=False):
        if not self.current_session_id:
            if show_msg: QMessageBox.warning(self, "Hata", "√ñnce bir oturum olu≈üturun.")
            return
            
        logs = self.txt_log.toHtml()
        notes = self.txt_notes.toPlainText()
        combat_state = self.combat_tracker.get_session_state()
        
        self.dm.save_session_data(self.current_session_id, notes, logs, combat_state)
        
        if show_msg:
            QMessageBox.information(self, tr("MSG_SUCCESS"), "Kaydedildi.")

--------------------------------------------------
Path: ui/tabs/database_tab.py
--------------------------------------------------
import os
from PyQt6.QtWidgets import (QWidget, QHBoxLayout, QVBoxLayout, QListWidget, 
                             QPushButton, QLineEdit, QComboBox, QSplitter, 
                             QMessageBox, QListWidgetItem, QCheckBox, QLabel, QFileDialog, QStyle)
from PyQt6.QtGui import QColor, QBrush, QAction, QDesktopServices, QPixmap
from PyQt6.QtCore import Qt, QUrl
from ui.widgets.npc_sheet import NpcSheet
from ui.dialogs.api_browser import ApiBrowser
from ui.dialogs.bulk_downloader import BulkDownloadDialog
from ui.workers import ApiSearchWorker
from core.models import ENTITY_SCHEMAS
from core.locales import tr

# --- √ñZEL B√úY√ú Lƒ∞STESƒ∞ √ñƒûESƒ∞ (G√∂rsel Zenginlik ƒ∞√ßin) ---
class SpellListItemWidget(QWidget):
    """B√ºy√º listesinde g√∂r√ºnecek zengin i√ßerikli satƒ±r"""
    def __init__(self, name, meta_text, desc):
        super().__init__()
        layout = QVBoxLayout(self)
        layout.setContentsMargins(5, 5, 5, 5)
        layout.setSpacing(2)
        
        # √úst Satƒ±r: ƒ∞sim ve (Seviye/Okul)
        top_row = QHBoxLayout()
        lbl_name = QLabel(f"<b>{name}</b>")
        lbl_name.setStyleSheet("font-size: 14px; color: #e0e0e0;")
        
        lbl_meta = QLabel(f"<i>{meta_text}</i>")
        lbl_meta.setStyleSheet("color: #ffb74d; font-size: 11px;")
        lbl_meta.setAlignment(Qt.AlignmentFlag.AlignRight | Qt.AlignmentFlag.AlignVCenter)
        
        top_row.addWidget(lbl_name)
        top_row.addWidget(lbl_meta)
        
        # Alt Satƒ±r: A√ßƒ±klama (Kƒ±rpƒ±lmƒ±≈ü ve Temizlenmi≈ü)
        clean_desc = desc.replace("\n", " ").replace("<br>", " ")
        short_desc = clean_desc[:95] + "..." if len(clean_desc) > 95 else clean_desc
        
        lbl_desc = QLabel(short_desc)
        lbl_desc.setStyleSheet("color: #aaa; font-size: 11px;")
        lbl_desc.setWordWrap(True)
        
        layout.addLayout(top_row)
        layout.addWidget(lbl_desc)

# --- ANA VERƒ∞TABANI SEKMESƒ∞ ---
class DatabaseTab(QWidget):
    def __init__(self, data_manager, player_window):
        super().__init__()
        self.dm = data_manager
        self.player_window = player_window
        self.current_entity_id = None
        
        # --- GEZƒ∞NME GE√áMƒ∞≈ûƒ∞ (HISTORY) ---
        self.history_back = []    # ID Listesi (Geri gitmek i√ßin)
        self.history_forward = [] # ID Listesi (ƒ∞leri gitmek i√ßin)
        self.is_navigating = False # D√∂ng√ºy√º engellemek i√ßin bayrak
        
        self.init_ui()

    def init_ui(self):
        layout = QHBoxLayout(self)
        splitter = QSplitter(Qt.Orientation.Horizontal)

        # --- SOL PANEL (Lƒ∞STE & ARA√áLAR) ---
        left_widget = QWidget()
        l_layout = QVBoxLayout(left_widget)
        l_layout.setContentsMargins(0, 0, 0, 0)
        
        # 1. Navigasyon ve Arama √áubuƒüu
        nav_search_layout = QHBoxLayout()
        
        # GERƒ∞ BUTONU
        self.btn_back = QPushButton()
        self.btn_back.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_ArrowBack))
        self.btn_back.setFixedSize(30, 30)
        self.btn_back.setEnabled(False) # Ba≈ülangƒ±√ßta pasif
        self.btn_back.setToolTip("Geri")
        self.btn_back.clicked.connect(self.go_back)
        
        # ƒ∞LERƒ∞ BUTONU
        self.btn_forward = QPushButton()
        self.btn_forward.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_ArrowForward))
        self.btn_forward.setFixedSize(30, 30)
        self.btn_forward.setEnabled(False) # Ba≈ülangƒ±√ßta pasif
        self.btn_forward.setToolTip("ƒ∞leri")
        self.btn_forward.clicked.connect(self.go_forward)
        
        # ARAMA KUTUSU
        self.inp_search = QLineEdit()
        self.inp_search.setPlaceholderText(tr("LBL_SEARCH"))
        self.inp_search.textChanged.connect(self.refresh_list)
        
        nav_search_layout.addWidget(self.btn_back)
        nav_search_layout.addWidget(self.btn_forward)
        nav_search_layout.addWidget(self.inp_search)
        
        # 2. Filtreler
        filter_layout = QHBoxLayout()
        self.combo_filter = QComboBox()
        self.combo_filter.addItems([tr("CAT_ALL")] + list(ENTITY_SCHEMAS.keys()))
        self.combo_filter.currentTextChanged.connect(self.refresh_list)
        
        self.check_show_library = QCheckBox(tr("LBL_CHECK_LIBRARY"))
        self.check_show_library.setChecked(True)
        self.check_show_library.stateChanged.connect(self.refresh_list)
        
        filter_layout.addWidget(self.combo_filter)
        filter_layout.addWidget(self.check_show_library)
        
        # 3. Aksiyon Butonlarƒ± (ƒ∞ndir / API)
        self.btn_download_all = QPushButton(tr("BTN_DOWNLOAD_ALL"))
        self.btn_download_all.clicked.connect(self.open_bulk_downloader)
        self.btn_download_all.setStyleSheet("background-color: #424242; color: #aaa; font-size: 11px;")

        self.btn_browser = QPushButton(tr("BTN_API_BROWSER"))
        self.btn_browser.clicked.connect(self.open_api_browser)
        self.btn_browser.setStyleSheet("background-color: #6a1b9a; color: white; font-weight: bold;")

        # 4. Ana Liste
        self.list_widget = QListWidget()
        self.list_widget.itemClicked.connect(self.on_item_clicked)
        
        # 5. Yeni Ekle Butonu
        self.btn_add = QPushButton(tr("BTN_NEW_ENTITY"))
        self.btn_add.setObjectName("successBtn")
        self.btn_add.clicked.connect(self.prepare_new)
        
        # Sol Paneli Birle≈ütir
        l_layout.addLayout(nav_search_layout)
        l_layout.addLayout(filter_layout)
        l_layout.addWidget(self.btn_download_all)
        l_layout.addWidget(self.btn_browser)
        l_layout.addWidget(self.list_widget)
        l_layout.addWidget(self.btn_add)

        # --- SAƒû PANEL (KARAKTER KARTI / NPCSHEET) ---
        self.sheet = NpcSheet()
        
        # Buton Baƒülantƒ±larƒ±
        self.sheet.btn_save.clicked.connect(self.save_entity)
        self.sheet.btn_delete.clicked.connect(self.delete_entity)
        self.sheet.btn_show_player.clicked.connect(self.show_image_to_player)
        
        # Galeri
        self.sheet.btn_add_img.clicked.connect(self.add_image_to_gallery)
        self.sheet.btn_remove_img.clicked.connect(self.remove_image_from_gallery)
        self.sheet.btn_prev_img.clicked.connect(self.prev_image)
        self.sheet.btn_next_img.clicked.connect(self.next_image)

        # PDF
        self.sheet.btn_add_pdf.clicked.connect(self.add_pdf)
        self.sheet.btn_remove_pdf.clicked.connect(self.remove_pdf)
        self.sheet.btn_open_pdf.clicked.connect(self.open_pdf)
        self.sheet.btn_project_pdf.clicked.connect(self.project_pdf_to_player)
        self.sheet.btn_open_pdf_folder.clicked.connect(self.open_pdf_folder)
        
        # ƒ∞statistik Yansƒ±tma Butonunu Sheet i√ßine enjekte et
        self.btn_show_stats = QPushButton(tr("BTN_SHOW_STATS"))
        self.btn_show_stats.setObjectName("primaryBtn")
        self.btn_show_stats.clicked.connect(self.show_stats_to_player)
        # Sheet'in ba≈ülƒ±k kƒ±smƒ±na ekliyoruz
        try:
            self.sheet.content_layout.itemAt(0).layout().itemAt(0).layout().insertWidget(3, self.btn_show_stats)
        except:
            pass # Layout yapƒ±sƒ± deƒüi≈üirse hata vermesin

        # B√ºy√º Listesi ƒ∞≈ülemleri
        self.sheet.btn_add_spell.clicked.connect(self.add_spell_to_list)
        self.sheet.btn_remove_spell.clicked.connect(self.remove_spell_from_list)
        # √áƒ∞FT TIKLAMA: B√ºy√º detayƒ±na git
        self.sheet.list_assigned_spells.itemDoubleClicked.connect(self.view_spell_details)
        
        # E≈üya Linkleme
        self.sheet.btn_add_item_link.clicked.connect(self.add_item_to_list)
        self.sheet.btn_remove_item_link.clicked.connect(self.remove_item_from_list)
        self.sheet.list_assigned_items.itemDoubleClicked.connect(self.view_item_details)

        splitter.addWidget(left_widget)
        splitter.addWidget(self.sheet)
        splitter.setSizes([350, 950])
        layout.addWidget(splitter)
        
        self.refresh_list()
        self.update_nav_buttons()

    # --- GEZƒ∞NME (NAVIGATION) MANTIƒûI ---
    def update_nav_buttons(self):
        """Butonlarƒ±n aktif/pasif durumunu g√ºncelle"""
        self.btn_back.setEnabled(len(self.history_back) > 0)
        self.btn_forward.setEnabled(len(self.history_forward) > 0)

    def go_back(self):
        """Geri butonuna basƒ±lƒ±nca"""
        if not self.history_back: return
        
        # ≈ûu anki sayfayƒ± ileri ge√ßmi≈üine at
        if self.current_entity_id:
            self.history_forward.append(self.current_entity_id)
            
        # Geri ge√ßmi≈üten sonuncuyu al
        prev_id = self.history_back.pop()
        
        self.is_navigating = True # History'ye tekrar eklemeyi engelle
        self.load_entity_by_id(prev_id)
        self.is_navigating = False
        
        self.update_nav_buttons()

    def go_forward(self):
        """ƒ∞leri butonuna basƒ±lƒ±nca"""
        if not self.history_forward: return
        
        # ≈ûu anki sayfayƒ± geri ge√ßmi≈üine at
        if self.current_entity_id:
            self.history_back.append(self.current_entity_id)
            
        # ƒ∞leri ge√ßmi≈üten sonuncuyu al
        next_id = self.history_forward.pop()
        
        self.is_navigating = True
        self.load_entity_by_id(next_id)
        self.is_navigating = False
        
        self.update_nav_buttons()

    def add_to_history(self, eid):
        """Yeni bir sayfa a√ßƒ±ldƒ±ƒüƒ±nda ge√ßmi≈üi g√ºnceller"""
        if self.is_navigating: return # Geri/ƒ∞leri tu≈ülarƒ±yla geldiysek ekleme
        
        # Eƒüer aynƒ± sayfaya tƒ±klanmadƒ±ysa ge√ßmi≈üe ekle
        if self.current_entity_id and self.current_entity_id != eid:
            self.history_back.append(self.current_entity_id)
            self.history_forward.clear() # Yeni bir dal a√ßƒ±ldƒ±ƒüƒ± i√ßin ileri ge√ßmi≈üi silinir
        
        self.update_nav_buttons()

    # --- Lƒ∞STELEME VE SE√áƒ∞M ---
    def refresh_list(self):
        self.list_widget.clear()
        text = self.inp_search.text().lower()
        flt = self.combo_filter.currentText()
        
        # 1. YEREL VARLIKLAR
        for eid, data in self.dm.data["entities"].items():
            name = data.get("name", "").lower()
            etype = data.get("type", "")
            if flt != tr("CAT_ALL") and etype != flt: continue
            
            if text in name or any(text in t.lower() for t in data.get("tags", [])):
                item = QListWidgetItem(f"üë§ {data['name']} ({etype})")
                item.setData(Qt.ItemDataRole.UserRole, eid)
                self.list_widget.addItem(item)

        # 2. K√úT√úPHANE VERƒ∞LERƒ∞ (OFFLINE/CACHE)
        if self.check_show_library.isChecked() and (len(text) > 2 or flt != "T√ºm√º"):
            lib_results = self.dm.search_in_library(flt, text)
            for res in lib_results:
                item = QListWidgetItem(f"üìö {res['name']} ({res['type']})")
                item.setForeground(QBrush(QColor("#aaa"))) # Hafif s√∂n√ºk renk
                item.setData(Qt.ItemDataRole.UserRole, res['id'])
                self.list_widget.addItem(item)

    def on_item_clicked(self, item):
        eid = item.data(Qt.ItemDataRole.UserRole)
        
        # K√ºt√ºphane √∂ƒüesi mi? (lib_category_index)
        if str(eid).startswith("lib_"):
            parts = eid.split("_")
            cat = parts[1]; idx = parts[2]
            
            self.sheet.inp_name.setText(tr("MSG_LOADING"))
            self.sheet.setEnabled(False)
            
            self.worker = ApiSearchWorker(self.dm, cat, idx)
            self.worker.finished.connect(self.on_api_search_finished)
            self.worker.start()
        else:
            # Normal yerel varlƒ±k
            self.load_entity(item)

    def on_api_search_finished(self, success, data_or_id, msg):
        self.sheet.setEnabled(True)
        if success:
            if isinstance(data_or_id, dict):
                # Yeni veri √ßekildi (hen√ºz ID'si yok)
                self.current_entity_id = None 
                self.add_to_history(None) # Bo≈ü ID olarak ge√ßmi≈üe ekle
                self.load_data_into_sheet(data_or_id)
                self.sheet.inp_name.setStyleSheet("border: 2px solid #2e7d32;")
            elif isinstance(data_or_id, str):
                # Zaten varmƒ±≈ü, ID d√∂nd√º
                self.load_entity_by_id(data_or_id)
        else:
            QMessageBox.warning(self, tr("MSG_ERROR"), f"{tr('MSG_ERROR')}: {msg}")

    # --- Y√úKLEME MANTIƒûI ---
    def load_entity(self, item):
        """Listeden tƒ±klanƒ±nca √ßalƒ±≈üƒ±r"""
        eid = item.data(Qt.ItemDataRole.UserRole)
        data = self.dm.data["entities"].get(eid)
        if not data: return
        
        self.add_to_history(eid)
        self.current_entity_id = eid
        self.load_data_into_sheet(data)
        self.sheet.inp_name.setStyleSheet("") 

    def load_entity_by_id(self, eid):
        """ID ile doƒürudan y√ºkleme (√áift tƒ±klama veya Navigasyon i√ßin)"""
        if eid not in self.dm.data["entities"]: return
        
        # Sol listede o √∂ƒüeyi bul ve se√ßili yap
        found = False
        for i in range(self.list_widget.count()):
            item = self.list_widget.item(i)
            if item.data(Qt.ItemDataRole.UserRole) == eid:
                self.list_widget.setCurrentItem(item)
                self.list_widget.scrollToItem(item)
                found = True
                break
        
        # Navigasyon sƒ±rasƒ±nda deƒüilsek history'ye ekle
        if not self.is_navigating:
            self.add_to_history(eid)
            
        self.current_entity_id = eid
        self.load_data_into_sheet(self.dm.data["entities"][eid])
        self.sheet.inp_name.setStyleSheet("")
        self.update_nav_buttons()

    def load_data_into_sheet(self, data):
        """T√ºm veriyi forma daƒüƒ±tƒ±r"""
        s = self.sheet
        
        # 1. Temel Bilgiler
        s.inp_name.setText(data.get("name", ""))
        curr_type = data.get("type", "NPC")
        idx = s.inp_type.findText(curr_type)
        s.inp_type.setCurrentIndex(idx if idx >= 0 else 0)
        s.inp_tags.setText(", ".join(data.get("tags", [])))
        s.inp_desc.setText(data.get("description", ""))
        
        # 2. Statlar
        stats = data.get("stats", {})
        for k, v in s.stats_inputs.items(): 
            v.setText(str(stats.get(k, 10)))
        
        # 3. Combat Stats
        c = data.get("combat_stats", {})
        s.inp_hp.setText(str(c.get("hp", "")))
        s.inp_max_hp.setText(str(c.get("max_hp", "")))
        s.inp_ac.setText(str(c.get("ac", ""))) 
        s.inp_speed.setText(str(c.get("speed", "")))
        s.inp_init.setText(str(c.get("initiative", "")))

        # 4. Geli≈ümi≈ü Statlar
        s.inp_saves.setText(data.get("saving_throws", ""))
        s.inp_skills.setText(data.get("skills", ""))
        s.inp_vuln.setText(data.get("damage_vulnerabilities", ""))
        s.inp_resist.setText(data.get("damage_resistances", ""))
        s.inp_dmg_immune.setText(data.get("damage_immunities", ""))
        s.inp_cond_immune.setText(data.get("condition_immunities", ""))
        s.inp_prof.setText(str(data.get("proficiency_bonus", "")))
        s.inp_pp.setText(str(data.get("passive_perception", "")))

        # 5. Dinamik Alanlar
        attrs = data.get("attributes", {})
        for l, w in s.dynamic_inputs.items():
            val = attrs.get(l, "")
            if isinstance(w, QComboBox): 
                ix = w.findText(val); w.setCurrentIndex(ix) if ix>=0 else w.setCurrentText(val)
            else: w.setText(str(val))

        # 6. Kartlar
        s.clear_all_cards()
        self._fill_cards(s.trait_container, data.get("traits", []))
        self._fill_cards(s.action_container, data.get("actions", []))
        self._fill_cards(s.reaction_container, data.get("reactions", []))
        self._fill_cards(s.legendary_container, data.get("legendary_actions", []))
        self._fill_cards(s.inventory_container, data.get("inventory", []))
        self._fill_cards(s.custom_spell_container, data.get("custom_spells", []))

        # 7. Resimler
        s.image_list = data.get("images", [])
        if not s.image_list and data.get("image_path"): 
            s.image_list = [data.get("image_path")]
        s.current_img_index = 0
        self.update_sheet_image()

        # 8. PDFler
        pdfs = data.get("pdfs", [])
        s.list_pdfs.clear()
        for pdf in pdfs:
             s.list_pdfs.addItem(os.path.basename(pdf))
             full = self.dm.get_full_path(pdf)
             item = s.list_pdfs.item(s.list_pdfs.count()-1)
             item.setData(Qt.ItemDataRole.UserRole, pdf)
             item.setToolTip(full if full else pdf)
        
        # 9. LOKASYON
        loc_id = data.get("location_id")
        if loc_id:
            idx = s.combo_location.findData(loc_id)
            if idx >= 0: s.combo_location.setCurrentIndex(idx)
        else: s.combo_location.setCurrentIndex(0)

        # 10. BAƒûLI B√úY√úLER (Rich Widget ile)
        s.list_assigned_spells.clear()
        for spell_id in data.get("spells", []):
            spell_ent = self.dm.data["entities"].get(spell_id)
            if spell_ent:
                name = spell_ent.get("name", "Bilinmiyor")
                attrs = spell_ent.get("attributes", {})
                level = attrs.get("Seviye", "?")
                school = attrs.get("Okul", "")
                
                # Meta bilgisi
                meta = f"Level {level} {school}" if school else f"Level {level}"
                desc = spell_ent.get("description", "")
                
                # List Item ve Custom Widget
                item = QListWidgetItem(s.list_assigned_spells)
                item.setData(Qt.ItemDataRole.UserRole, spell_id) # ID sakla
                
                widget = SpellListItemWidget(name, meta, desc)
                item.setSizeHint(widget.sizeHint())
                
                s.list_assigned_spells.setItemWidget(item, widget)

        # 11. BAƒûLI E≈ûYALAR
        s.list_assigned_items.clear()
        for item_id in data.get("equipment_ids", []):
            item_name = self.dm.get_entity_name(item_id)
            if item_name:
                item = QListWidgetItem(item_name)
                item.setData(Qt.ItemDataRole.UserRole, item_id)
                s.list_assigned_items.addItem(item)

    # --- SAVE / DELETE / ACTIONS ---
    def save_entity(self):
        s = self.sheet
        if not s.inp_name.text(): return
        
        def get_cards(container):
            res = []; layout = container.dynamic_area
            for i in range(layout.count()):
                w = layout.itemAt(i).widget()
                if w: res.append({"name": w.inp_title.text(), "desc": w.inp_desc.toPlainText()})
            return res
            
        data = {
            "name": s.inp_name.text(), 
            "type": s.inp_type.currentText(),
            "tags": [t.strip() for t in s.inp_tags.text().split(",") if t.strip()],
            "description": s.inp_desc.toPlainText(),
            "images": s.image_list, 
            "image_path": s.image_list[0] if s.image_list else "",
            
            # Statlar
            "stats": {k: int(v.text() or 10) for k, v in s.stats_inputs.items()},
            "combat_stats": {
                "hp": s.inp_hp.text(),
                "max_hp": s.inp_max_hp.text(),
                "ac": s.inp_ac.text(),
                "speed": s.inp_speed.text(),
                "initiative": s.inp_init.text()
            },
            # Geli≈ümi≈ü Statlar
            "saving_throws": s.inp_saves.text(),
            "skills": s.inp_skills.text(),
            "damage_vulnerabilities": s.inp_vuln.text(),
            "damage_resistances": s.inp_resist.text(),
            "damage_immunities": s.inp_dmg_immune.text(),
            "condition_immunities": s.inp_cond_immune.text(),
            "proficiency_bonus": s.inp_prof.text(),
            "passive_perception": s.inp_pp.text(),
            
            "attributes": {l: (w.currentText() if isinstance(w, QComboBox) else w.text()) for l, w in s.dynamic_inputs.items()},
            
            # ƒ∞li≈ükiler
            "location_id": s.combo_location.currentData() if s.combo_location.isVisible() else None,
            "spells": [s.list_assigned_spells.item(i).data(Qt.ItemDataRole.UserRole) for i in range(s.list_assigned_spells.count())],
            "equipment_ids": [s.list_assigned_items.item(i).data(Qt.ItemDataRole.UserRole) for i in range(s.list_assigned_items.count())],
            "pdfs": [s.list_pdfs.item(i).data(Qt.ItemDataRole.UserRole) for i in range(s.list_pdfs.count())],
            
            # Kartlar
            "traits": get_cards(s.trait_container), 
            "actions": get_cards(s.action_container),
            "reactions": get_cards(s.reaction_container), 
            "legendary_actions": get_cards(s.legendary_container),
            "inventory": get_cards(s.inventory_container), 
            "custom_spells": get_cards(s.custom_spell_container)
        }
        
        new_id = self.dm.save_entity(self.current_entity_id, data)
        
        # Eƒüer yeni kayƒ±tsa ID'yi g√ºncelle ve listeyi yenile
        if self.current_entity_id != new_id:
            self.current_entity_id = new_id
            self.add_to_history(new_id)
        
        self.refresh_list()
        s.inp_name.setStyleSheet("")
        QMessageBox.information(self, tr("MSG_SUCCESS"), tr("MSG_SUCCESS"))

    def delete_entity(self):
        if self.current_entity_id: 
            if QMessageBox.question(self, tr("BTN_DELETE"), "Emin misiniz?") == QMessageBox.StandardButton.Yes:
                self.dm.delete_entity(self.current_entity_id)
                self.refresh_list()
                self.prepare_new()

    def prepare_new(self): 
        self.current_entity_id = None
        self.sheet.prepare_new_entity()
        self.add_to_history(None) # Bo≈ü history ekle ki geri gelebilelim
        self.sheet.inp_name.setFocus()

    # --- GALERƒ∞ & RESƒ∞M ---
    def add_image_to_gallery(self):
        fname, _ = QFileDialog.getOpenFileName(self, "Resim Se√ß", "", "Images (*.png *.jpg *.jpeg *.bmp)")
        if fname:
            rel = self.dm.import_image(fname)
            self.sheet.image_list.append(rel)
            self.sheet.current_img_index = len(self.sheet.image_list) - 1
            self.update_sheet_image()

    def remove_image_from_gallery(self):
        if not self.sheet.image_list: return
        del self.sheet.image_list[self.sheet.current_img_index]
        if self.sheet.current_img_index >= len(self.sheet.image_list):
            self.sheet.current_img_index = max(0, len(self.sheet.image_list) - 1)
        self.update_sheet_image()

    def prev_image(self):
        if not self.sheet.image_list: return
        self.sheet.current_img_index = (self.sheet.current_img_index - 1) % len(self.sheet.image_list)
        self.update_sheet_image()

    def next_image(self):
        if not self.sheet.image_list: return
        self.sheet.current_img_index = (self.sheet.current_img_index + 1) % len(self.sheet.image_list)
        self.update_sheet_image()

    def update_sheet_image(self):
        s = self.sheet
        if not s.image_list:
            s.lbl_image.setPixmap(None)
            s.lbl_img_counter.setText("0/0")
            return
        
        if s.current_img_index < 0: s.current_img_index = 0
        if s.current_img_index >= len(s.image_list): s.current_img_index = len(s.image_list) - 1
        
        rel = s.image_list[s.current_img_index]
        p = self.dm.get_full_path(rel)
        s.lbl_image.setPixmap(QPixmap(p) if p and os.path.exists(p) else None)
        s.lbl_img_counter.setText(f"{s.current_img_index + 1}/{len(s.image_list)}")

    # --- SHOW PLAYER ---
    def show_image_to_player(self):
        if not self.player_window.isVisible(): return
        if self.sheet.image_list:
            rel = self.sheet.image_list[self.sheet.current_img_index]
            p = self.dm.get_full_path(rel)
            self.player_window.show_image(QPixmap(p) if p and os.path.exists(p) else None)

    def show_stats_to_player(self):
        if not self.player_window.isVisible():
            QMessageBox.warning(self, "Uyarƒ±", "Oyuncu ekranƒ± kapalƒ±.")
            return
        if not self.current_entity_id: return

        data = self.dm.data["entities"].get(self.current_entity_id, {})
        self.player_window.show_stat_block(f"<h1>{data.get('name')}</h1><p>{data.get('description')}</p>")

    # --- PDF ---
    def add_pdf(self):
        fname, _ = QFileDialog.getOpenFileName(self, tr("MSG_SELECT_PDF"), "", "PDF Files (*.pdf)")
        if fname:
            rel = self.dm.import_pdf(fname)
            self.sheet.list_pdfs.addItem(os.path.basename(rel))
            item = self.sheet.list_pdfs.item(self.sheet.list_pdfs.count()-1)
            item.setData(Qt.ItemDataRole.UserRole, rel)

    def remove_pdf(self):
        r = self.sheet.list_pdfs.currentRow()
        if r >= 0: self.sheet.list_pdfs.takeItem(r)

    def open_pdf(self):
        item = self.sheet.list_pdfs.currentItem()
        if item:
            full = self.dm.get_full_path(item.data(Qt.ItemDataRole.UserRole))
            if full: QDesktopServices.openUrl(QUrl.fromLocalFile(full))

    def project_pdf_to_player(self):
        item = self.sheet.list_pdfs.currentItem()
        if item and self.player_window.isVisible():
            full = self.dm.get_full_path(item.data(Qt.ItemDataRole.UserRole))
            if full: self.player_window.show_pdf(full)
            
    def open_pdf_folder(self):
         if self.dm.current_campaign_path:
             path = os.path.join(self.dm.current_campaign_path, "assets")
             QDesktopServices.openUrl(QUrl.fromLocalFile(path))

    # --- DIALOGS ---
    def open_api_browser(self):
        cat = self.combo_filter.currentText()
        if cat == "T√ºm√º": return QMessageBox.warning(self, "Uyarƒ±", "L√ºtfen bir kategori se√ßin.")
        if ApiBrowser(self.dm, cat, self).exec(): self.refresh_list()
        
    def open_bulk_downloader(self): 
        BulkDownloadDialog(self).exec()

    # --- LINKED SPELLS & ITEMS (√áift Tƒ±klama & Ekleme) ---
    def add_spell_to_list(self):
        sid = self.sheet.combo_all_spells.currentData()
        if sid:
            spell_ent = self.dm.data["entities"].get(sid)
            if spell_ent:
                item = QListWidgetItem(self.sheet.list_assigned_spells)
                item.setData(Qt.ItemDataRole.UserRole, sid)
                w = SpellListItemWidget(spell_ent.get("name"), "Yeni Eklendi", "")
                item.setSizeHint(w.sizeHint())
                self.sheet.list_assigned_spells.setItemWidget(item, w)

    def remove_spell_from_list(self):
        r = self.sheet.list_assigned_spells.currentRow()
        if r>=0: self.sheet.list_assigned_spells.takeItem(r)
        
    def view_spell_details(self, item):
        self.load_entity_by_id(item.data(Qt.ItemDataRole.UserRole))
        
    def add_item_to_list(self):
        iid = self.sheet.combo_all_items.currentData()
        if iid:
            txt = self.sheet.combo_all_items.currentText()
            li = QListWidgetItem(txt); li.setData(Qt.ItemDataRole.UserRole, iid)
            self.sheet.list_assigned_items.addItem(li)
            
    def remove_item_from_list(self):
        r = self.sheet.list_assigned_items.currentRow()
        if r>=0: self.sheet.list_assigned_items.takeItem(r)
        
    def view_item_details(self, item):
        self.load_entity_by_id(item.data(Qt.ItemDataRole.UserRole))
        
    # Helper functions
    def _fill_cards(self, container, data_list):
        for item in data_list: self.sheet.add_feature_card(container, item.get("name"), item.get("desc"))

--------------------------------------------------
Path: ui/windows/battle_map_window.py
--------------------------------------------------
from PyQt6.QtWidgets import (QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, 
                             QLabel, QScrollArea, QFrame, QGraphicsView, 
                             QGraphicsScene, QGraphicsEllipseItem, QSlider, QGraphicsPixmapItem)
from PyQt6.QtGui import QPixmap, QColor, QFont, QBrush, QPen, QPainter
from PyQt6.QtCore import Qt, QRectF, pyqtSignal, QPointF

# --- TOKEN (PUL) SINIFI ---
class BattleTokenItem(QGraphicsEllipseItem):
    def __init__(self, size, pixmap, border_color, name, eid, on_move_callback):
        super().__init__(0, 0, size, size)
        
        self.eid = eid
        self.name = name
        self.on_move_callback = on_move_callback 
        self.original_pixmap = pixmap 
        self.border_color = border_color
        
        # Hareket ve Se√ßim Bayraklarƒ±
        self.setFlag(QGraphicsEllipseItem.GraphicsItemFlag.ItemIsMovable)
        self.setFlag(QGraphicsEllipseItem.GraphicsItemFlag.ItemIsSelectable)
        self.setFlag(QGraphicsEllipseItem.GraphicsItemFlag.ItemSendsGeometryChanges)
        
        self.setToolTip(name)
        self.update_appearance(size)

    def update_appearance(self, size):
        self.setRect(0, 0, size, size)
        
        pen = QPen(QColor(self.border_color))
        pen.setWidth(3)
        self.setPen(pen)
        
        if self.original_pixmap and not self.original_pixmap.isNull():
            scaled = self.original_pixmap.scaled(int(size), int(size), 
                                               Qt.AspectRatioMode.KeepAspectRatioByExpanding, 
                                               Qt.TransformationMode.SmoothTransformation)
            brush = QBrush(scaled)
            self.setBrush(brush)
        else:
            self.setBrush(QBrush(QColor("#444")))

    def mouseReleaseEvent(self, event):
        super().mouseReleaseEvent(event)
        if self.on_move_callback:
            self.on_move_callback(self.eid, self.pos().x(), self.pos().y())

# --- ANA PENCERE ---
class BattleMapWindow(QMainWindow):
    token_moved_signal = pyqtSignal(str, float, float)

    def __init__(self, data_manager):
        super().__init__()
        self.dm = data_manager
        self.tokens = {} 
        self.token_size = 50 
        self.map_item = None
        
        self.setWindowTitle("Battle Map (Sava≈ü Masasƒ±)")
        self.resize(1200, 800)
        self.setStyleSheet("background-color: #121212; color: #e0e0e0;")
        
        central = QWidget()
        self.setCentralWidget(central)
        main_layout = QHBoxLayout(central)
        main_layout.setContentsMargins(0, 0, 0, 0)
        
        # --- SOL: HARƒ∞TA ALANI ---
        map_layout = QVBoxLayout()
        
        # Toolbar
        toolbar = QHBoxLayout()
        toolbar.setContentsMargins(10, 5, 10, 5)
        lbl_size = QLabel("Token Boyutu:")
        self.slider_size = QSlider(Qt.Orientation.Horizontal)
        self.slider_size.setMinimum(20); self.slider_size.setMaximum(300)
        self.slider_size.setValue(self.token_size)
        self.slider_size.valueChanged.connect(self.change_token_size)
        self.slider_size.setFixedWidth(200)
        toolbar.addWidget(lbl_size); toolbar.addWidget(self.slider_size); toolbar.addStretch()
        map_layout.addLayout(toolbar)
        
        # Grafik Sahnesi ve G√∂r√ºn√ºm√º
        self.scene = QGraphicsScene()
        self.scene.setBackgroundBrush(QBrush(QColor("#111")))
        
        self.view = QGraphicsView(self.scene)
        self.view.setRenderHint(QPainter.RenderHint.Antialiasing)
        self.view.setRenderHint(QPainter.RenderHint.SmoothPixmapTransform)
        self.view.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)
        self.view.setStyleSheet("border: none;")
        
        # Scroll barlarƒ± kapat (Tam sƒ±ƒüdƒ±racaƒüƒ±mƒ±z i√ßin gerek yok)
        self.view.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        self.view.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        
        map_layout.addWidget(self.view)
        
        # --- SAƒû: SIDEBAR ---
        self.sidebar = QWidget()
        self.sidebar.setFixedWidth(300)
        self.sidebar.setStyleSheet("background-color: #1e1e1e; border-left: 1px solid #333;")
        sidebar_layout = QVBoxLayout(self.sidebar)
        
        lbl_title = QLabel("‚öîÔ∏è Sava≈ü Sƒ±rasƒ±")
        lbl_title.setStyleSheet("font-size: 16px; font-weight: bold; color: #ffb74d; padding: 10px; border-bottom: 1px solid #444;")
        lbl_title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        sidebar_layout.addWidget(lbl_title)
        
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setFrameShape(QFrame.Shape.NoFrame)
        self.list_container = QWidget()
        self.list_layout = QVBoxLayout(self.list_container)
        self.list_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        self.list_layout.setSpacing(5)
        scroll.setWidget(self.list_container)
        sidebar_layout.addWidget(scroll)
        
        main_layout.addLayout(map_layout, 1)
        main_layout.addWidget(self.sidebar, 0)

    # --- EKRAN BOYUTLANDIRMA OLAYI ---
    def resizeEvent(self, event):
        """Pencere boyutu deƒüi≈ütiƒüinde haritayƒ± tekrar sƒ±ƒüdƒ±r"""
        if self.map_item:
            self.fit_map_in_view()
        super().resizeEvent(event)

    def showEvent(self, event):
        """Pencere ilk a√ßƒ±ldƒ±ƒüƒ±nda haritayƒ± sƒ±ƒüdƒ±r"""
        if self.map_item:
            self.fit_map_in_view()
        super().showEvent(event)

    def fit_map_in_view(self):
        """Haritayƒ± g√∂r√ºnt√º alanƒ±na (bozulmadan) sƒ±ƒüdƒ±rƒ±r"""
        if self.map_item:
            self.view.fitInView(self.map_item, Qt.AspectRatioMode.KeepAspectRatio)

    def set_map_image(self, pixmap):
        if pixmap:
            if self.map_item: self.scene.removeItem(self.map_item)
            
            self.map_item = QGraphicsPixmapItem(pixmap)
            self.map_item.setZValue(-100)
            self.map_item.setTransformationMode(Qt.TransformationMode.SmoothTransformation)
            self.scene.addItem(self.map_item)
            self.scene.setSceneRect(self.map_item.boundingRect())
            
            # Resmi y√ºkler y√ºklemez sƒ±ƒüdƒ±r
            self.fit_map_in_view()
        else:
            if self.map_item: self.scene.removeItem(self.map_item)
            self.map_item = None

    def change_token_size(self, val):
        self.token_size = val
        for token in self.tokens.values():
            token.update_appearance(self.token_size)

    def on_token_moved(self, eid, x, y):
        self.token_moved_signal.emit(eid, x, y)

    def update_combat_data(self, combatants, current_index, map_path=None, saved_token_size=None):
        if saved_token_size:
            self.token_size = saved_token_size
            self.slider_size.blockSignals(True)
            self.slider_size.setValue(saved_token_size)
            self.slider_size.blockSignals(False)

        if map_path:
            self.set_map_image(QPixmap(map_path))

        # Sidebar Temizle
        while self.list_layout.count():
            item = self.list_layout.takeAt(0)
            if item.widget(): item.widget().deleteLater()
            
        active_ids = [c.get("eid") for c in combatants if c.get("eid")]
        
        # Token Temizle
        to_remove = [eid for eid in self.tokens if eid not in active_ids]
        for eid in to_remove:
            self.scene.removeItem(self.tokens[eid])
            del self.tokens[eid]

        # Listeyi G√ºncelle
        for i, c in enumerate(combatants):
            eid = c.get("eid")
            name = c.get("name", "???")
            hp = c.get("hp", "?")
            x, y = c.get("x"), c.get("y")
            
            is_player = False
            img_path = None
            if eid and eid in self.dm.data["entities"]:
                ent = self.dm.data["entities"][eid]
                if ent.get("type") == "Oyuncu": is_player = True
                
                rel_path = ent.get("image_path")
                if not rel_path and ent.get("images"): rel_path = ent.get("images")[0]
                if rel_path: img_path = self.dm.get_full_path(rel_path)

            # Sidebar Kartƒ±
            card = QFrame()
            card_layout = QHBoxLayout(card); card_layout.setContentsMargins(5,5,5,5)
            style = "border: 2px solid #66bb6a;" if i == current_index else "border: 1px solid #444;"
            bg = "#2e7d32" if i == current_index else "#2b2b2b"
            card.setStyleSheet(f"background-color: {bg}; {style} border-radius: 5px;")
            
            lbl_name = QLabel(name); lbl_name.setStyleSheet("font-weight: bold;")
            hp_txt = f"{hp} HP" if is_player else "HP: ???"
            lbl_hp = QLabel(hp_txt); lbl_hp.setStyleSheet("color: #ef5350;" if is_player else "color: #888; font-style: italic;")
            card_layout.addWidget(lbl_name, 1); card_layout.addWidget(lbl_hp, 0)
            self.list_layout.addWidget(card)

            # Token G√ºncelleme
            if eid:
                border = "#ffb74d" if i == current_index else ("#4caf50" if is_player else "#d32f2f")
                
                if eid in self.tokens:
                    token = self.tokens[eid]
                    token.border_color = border
                    token.update_appearance(self.token_size)
                    token.setZValue(100 if i == current_index else 10)
                    
                    if x is not None and y is not None:
                         # S√ºr√ºklerken titremesin diye tolerans
                         if abs(token.x() - x) > 1 or abs(token.y() - y) > 1:
                             token.setPos(x, y)
                else:
                    pixmap = QPixmap(img_path) if img_path else None
                    token = BattleTokenItem(self.token_size, pixmap, border, name, eid, self.on_token_moved)
                    
                    if x is not None and y is not None:
                        token.setPos(x, y)
                    else:
                        offset = len(self.tokens) * (self.token_size + 10)
                        token.setPos(50 + offset, 50)
                    
                    self.scene.addItem(token)
                    self.tokens[eid] = token

--------------------------------------------------
Path: ui/dialogs/api_browser.py
--------------------------------------------------
from PyQt6.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QListWidget, 
                             QLineEdit, QPushButton, QLabel, QTextEdit, 
                             QMessageBox, QListWidgetItem, QSplitter, QWidget, QApplication)
from PyQt6.QtCore import Qt
from ui.workers import ApiListWorker, ApiSearchWorker
from core.locales import tr

class ApiBrowser(QDialog):
    def __init__(self, data_manager, category, parent=None):
        super().__init__(parent)
        self.dm = data_manager
        self.category = category
        self.selected_data = None
        
        self.setWindowTitle(f"{tr('TITLE_API')}: {category}")
        self.resize(900, 600)
        self.setStyleSheet("""
            QDialog { background-color: #1e1e1e; color: white; }
            QLineEdit { padding: 8px; background-color: #333; color: white; border: 1px solid #555; }
            QListWidget { background-color: #252526; border: 1px solid #444; }
            QListWidget::item { padding: 5px; }
            QListWidget::item:selected { background-color: #007acc; }
            QTextEdit { background-color: #2b2b2b; border: 1px solid #444; }
            QPushButton { padding: 10px; background-color: #444; color: white; font-weight: bold; border: none; }
            QPushButton:hover { background-color: #555; }
            QPushButton#importBtn { background-color: #2e7d32; }
            QPushButton#importBtn:hover { background-color: #1b5e20; }
        """)
        
        self.full_list = [] # API'den gelen ham liste
        self.init_ui()
        self.load_list()

    def init_ui(self):
        main_layout = QVBoxLayout(self)
        
        # √úst: Arama
        self.inp_filter = QLineEdit()
        self.inp_filter.setPlaceholderText(f"{tr('LBL_SEARCH_API')} ({self.category})")
        self.inp_filter.textChanged.connect(self.filter_list)
        main_layout.addWidget(self.inp_filter)
        
        # Orta: Splitter (Liste | √ñnizleme)
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Sol: Liste
        self.list_widget = QListWidget()
        self.list_widget.itemClicked.connect(self.on_item_clicked)
        splitter.addWidget(self.list_widget)
        
        # Saƒü: √ñnizleme
        preview_widget = QWidget()
        prev_layout = QVBoxLayout(preview_widget)
        prev_layout.setContentsMargins(0,0,0,0)
        
        self.lbl_name = QLabel("Se√ßim Yok")
        self.lbl_name.setStyleSheet("font-size: 18px; font-weight: bold; color: #ffa500; margin-bottom: 5px;")
        
        self.txt_desc = QTextEdit()
        self.txt_desc.setReadOnly(True)
        
        self.btn_import = QPushButton(tr("BTN_IMPORT"))
        self.btn_import.setObjectName("importBtn")
        self.btn_import.setEnabled(False)
        self.btn_import.clicked.connect(self.import_selected)
        
        prev_layout.addWidget(self.lbl_name)
        prev_layout.addWidget(self.txt_desc)
        prev_layout.addWidget(self.btn_import)
        
        splitter.addWidget(preview_widget)
        splitter.setSizes([300, 600])
        
        main_layout.addWidget(splitter)

    def load_list(self):
        self.list_widget.clear()
        self.lbl_name.setText(tr("MSG_LOADING"))
        self.setEnabled(False)
        
        # Worker ile listeyi √ßek
        self.list_worker = ApiListWorker(self.dm.api_client, self.category)
        self.list_worker.finished.connect(self.on_list_loaded)
        self.list_worker.start()

    def on_list_loaded(self, data):
        self.setEnabled(True)
        self.lbl_name.setText("Se√ßim Yok")
        self.full_list = data
        
        if not self.full_list:
            QMessageBox.information(self, "Bilgi", "Liste bo≈ü veya API'ye eri≈üilemedi.")
            return

        # Listeyi doldur
        for item in self.full_list:
            list_item = QListWidgetItem(item["name"])
            list_item.setData(Qt.ItemDataRole.UserRole, item["index"])
            self.list_widget.addItem(list_item)

    def filter_list(self):
        query = self.inp_filter.text().lower()
        self.list_widget.clear()
        for item in self.full_list:
            if query in item["name"].lower():
                list_item = QListWidgetItem(item["name"])
                list_item.setData(Qt.ItemDataRole.UserRole, item["index"])
                self.list_widget.addItem(list_item)

    def on_item_clicked(self, item):
        index_name = item.data(Qt.ItemDataRole.UserRole)
        
        # Kullanƒ±cƒ±ya "Y√ºkleniyor..." hissi ver
        self.lbl_name.setText(item.text() + " (Y√ºkleniyor...)")
        self.txt_desc.clear()
        self.btn_import.setEnabled(False)
        self.list_widget.setEnabled(False)
        
        # Worker ile detaylarƒ± √ßek
        self.detail_worker = ApiSearchWorker(self.dm, self.category, index_name)
        self.detail_worker.finished.connect(self.on_details_loaded)
        self.detail_worker.start()

    def on_details_loaded(self, success, data_or_id, msg):
        self.list_widget.setEnabled(True)
        
        if success:
            data = data_or_id
            self.selected_data = data
            self.lbl_name.setText(data.get("name"))
            
            # A√ßƒ±klamayƒ± olu≈ütur
            desc = f"Tip: {data.get('type')}\n\n"
            desc += data.get("description", "")
            
            # Statlar vs varsa ekle
            if "attributes" in data:
                desc += "\n\n--- √ñzellikler ---\n"
                for k, v in data["attributes"].items():
                    desc += f"{k}: {v}\n"
            
            self.txt_desc.setText(desc)
            self.btn_import.setEnabled(True)
        else:
            self.lbl_name.setText(tr("MSG_ERROR"))
            self.txt_desc.setText(msg)

    def import_selected(self):
        if self.selected_data:
            # Kullanƒ±cƒ±ya geri bildirim ver
            self.btn_import.setEnabled(False)
            self.btn_import.setText("Veriler ve B√ºy√ºler ƒ∞ndiriliyor...")
            QApplication.processEvents() # Aray√ºz√ºn donmamasƒ± i√ßin
            
            try:
                # Yeni "dependency-aware" import metodunu √ßaƒüƒ±r
                # Bu metod detected_spells'i i≈üleyip temizleyecek ve kaydecek
                new_id = self.dm.import_entity_with_dependencies(self.selected_data)
                
                QMessageBox.information(self, tr("MSG_SUCCESS"), f"'{self.selected_data['name']}' ba≈üarƒ±yla aktarƒ±ldƒ±.\n(Varsa b√ºy√ºleri de eklendi.)")
                self.accept()
            except Exception as e:
                self.btn_import.setEnabled(True)
                self.btn_import.setText(tr("BTN_IMPORT"))
                QMessageBox.critical(self, tr("MSG_ERROR"), f"Hata olu≈ütu: {str(e)}")

--------------------------------------------------
Path: ui/dialogs/bulk_downloader.py
--------------------------------------------------
import os
import json
import requests
import time
from PyQt6.QtWidgets import (QDialog, QVBoxLayout, QLabel, QProgressBar, 
                             QPushButton, QTextEdit, QMessageBox)
from PyQt6.QtCore import Qt, QThread, pyqtSignal
from config import BASE_DIR, API_BASE_URL
from core.locales import tr

# K√ºt√ºphane deposu
LIBRARY_DIR = os.path.join(BASE_DIR, "cache", "library")

class DownloadWorker(QThread):
    progress_signal = pyqtSignal(int)
    log_signal = pyqtSignal(str)
    finished_signal = pyqtSignal()

    def __init__(self):
        super().__init__()
        self.is_running = True
        # ƒ∞ndirilecek kategoriler ve endpointleri
        self.categories = {
            "monsters": "Canavarlar",
            "spells": "B√ºy√ºler",
            "equipment": "Ekipmanlar",
            "magic-items": "B√ºy√ºl√º E≈üyalar",
            "classes": "Sƒ±nƒ±flar",
            "races": "Irklar"
        }

    def run(self):
        self.log_signal.emit("üöÄ ƒ∞ndirme i≈ülemi ba≈ülatƒ±lƒ±yor...")
        
        # Toplam i≈ülem sayƒ±sƒ±nƒ± tahmin et (Listeleri √ßekince g√ºncellenecek)
        total_items = 0
        current_count = 0
        
        session = requests.Session()
        
        # 1. Adƒ±m: Listeleri √áek
        lists = {}
        for endpoint, name in self.categories.items():
            if not self.is_running: break
            self.log_signal.emit(f"üìÇ Liste indiriliyor: {name}...")
            try:
                url = f"{API_BASE_URL}/{endpoint}"
                resp = session.get(url)
                if resp.status_code == 200:
                    data = resp.json()
                    items = data.get("results", [])
                    lists[endpoint] = items
                    total_items += len(items)
                    
                    # Listeyi kaydet (Index Cache)
                    self._save_index(endpoint, items)
                else:
                    self.log_signal.emit(f"‚ùå Hata: {name} listesi alƒ±namadƒ±.")
            except Exception as e:
                self.log_signal.emit(f"‚ùå Baƒülantƒ± hatasƒ±: {e}")

        self.log_signal.emit(f"‚úÖ Toplam {total_items} veri indirilecek.")
        
        # 2. Adƒ±m: Detaylarƒ± ƒ∞ndir
        for endpoint, items in lists.items():
            category_dir = os.path.join(LIBRARY_DIR, endpoint)
            if not os.path.exists(category_dir):
                os.makedirs(category_dir)
            
            self.log_signal.emit(f"‚¨áÔ∏è ƒ∞ndiriliyor: {self.categories[endpoint]}...")
            
            for item in items:
                if not self.is_running: break
                
                index = item["index"]
                file_path = os.path.join(category_dir, f"{index}.json")
                
                # Eƒüer dosya zaten varsa indirme (Zaman kazanmak i√ßin)
                if os.path.exists(file_path):
                    current_count += 1
                    progress = int((current_count / total_items) * 100)
                    self.progress_signal.emit(progress)
                    continue

                try:
                    url = f"{API_BASE_URL}/{endpoint}/{index}"
                    resp = session.get(url)
                    if resp.status_code == 200:
                        with open(file_path, "w", encoding="utf-8") as f:
                            json.dump(resp.json(), f, indent=4)
                    
                    # √áok hƒ±zlƒ± yaparsak API engelleyebilir, minik bekleme
                    time.sleep(0.05) 
                    
                except Exception as e:
                    self.log_signal.emit(f"‚ö†Ô∏è Atlandƒ±: {item['name']}")

                current_count += 1
                progress = int((current_count / total_items) * 100)
                self.progress_signal.emit(progress)

        self.finished_signal.emit()

    def _save_index(self, category, data):
        # Index dosyasƒ±nƒ± da g√ºncelle (ApiBrowser i√ßin)
        index_file = os.path.join(BASE_DIR, "cache", "reference_indexes.json")
        try:
            if os.path.exists(index_file):
                with open(index_file, "r", encoding="utf-8") as f:
                    full_index = json.load(f)
            else:
                full_index = {}
            
            # Kategori isim e≈üle≈ütirmesi (Bizim app -> API endpoint)
            # data_manager.py i√ßinde kullandƒ±ƒüƒ±mƒ±z keylere √ßevirmeliyiz
            key_map = {
                "monsters": "Canavar",
                "spells": "B√ºy√º (Spell)",
                "equipment": "E≈üya (Equipment)", # Magic itemleri de buna ekleyeceƒüiz
                "magic-items": "Magic Item",
                "classes": "Sƒ±nƒ±f (Class)",
                "races": "Irk (Race)"
            }
            
            app_key = key_map.get(category)
            if app_key:
                # E≈üya ve Magic Item birle≈üimi i√ßin kontrol
                if app_key == "E≈üya (Equipment)" and "E≈üya (Equipment)" in full_index:
                     # Magic item ise var olan listeye ekle, equipment ise √ºzerine yaz (sƒ±ra √∂nemli deƒüil)
                     # Basit√ße overwrite veya append yapalƒ±m.
                     # ≈ûimdilik direkt atayalƒ±m, data_manager zaten y√∂netiyor.
                     if category == "magic-items":
                         if "E≈üya (Equipment)" in full_index:
                             full_index["E≈üya (Equipment)"].extend(data)
                         else:
                             full_index["E≈üya (Equipment)"] = data
                     else:
                         full_index[app_key] = data
                else:
                    full_index[app_key] = data

            with open(index_file, "w", encoding="utf-8") as f:
                json.dump(full_index, f, indent=4)
        except Exception as e:
            print(f"Index kayƒ±t hatasƒ±: {e}")

    def stop(self):
        self.is_running = False

class BulkDownloadDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle(tr("TITLE_DOWNLOADER"))
        self.setFixedSize(500, 400)
        self.setStyleSheet("background-color: #1e1e1e; color: white;")
        
        self.worker = None
        self.init_ui()

    def init_ui(self):
        layout = QVBoxLayout(self)
        
        lbl_info = QLabel(f"{tr('TITLE_DOWNLOADER')}: {tr('MSG_WARNING')} (2-5 min)") # Basit bir mesaj
        lbl_info.setWordWrap(True)
        lbl_info.setStyleSheet("color: #ccc; font-size: 14px; margin-bottom: 10px;")
        layout.addWidget(lbl_info)
        
        self.progress_bar = QProgressBar()
        self.progress_bar.setValue(0)
        self.progress_bar.setStyleSheet("""
            QProgressBar { border: 2px solid #444; border-radius: 5px; text-align: center; }
            QProgressBar::chunk { background-color: #007acc; width: 20px; }
        """)
        layout.addWidget(self.progress_bar)
        
        self.txt_log = QTextEdit()
        self.txt_log.setReadOnly(True)
        self.txt_log.setStyleSheet("background-color: #111; border: 1px solid #333; font-family: Consolas;")
        layout.addWidget(self.txt_log)
        
        self.btn_start = QPushButton(tr("BTN_START_DOWNLOAD"))
        self.btn_start.setStyleSheet("background-color: #2e7d32; color: white; padding: 10px; font-weight: bold;")
        self.btn_start.clicked.connect(self.start_download)
        layout.addWidget(self.btn_start)

    def start_download(self):
        self.btn_start.setEnabled(False)
        self.btn_start.setText(f"{tr('MSG_LOADING')}...")
        self.txt_log.clear()
        
        self.worker = DownloadWorker()
        self.worker.progress_signal.connect(self.update_progress)
        self.worker.log_signal.connect(self.update_log)
        self.worker.finished_signal.connect(self.on_finished)
        self.worker.start()

    def update_progress(self, val):
        self.progress_bar.setValue(val)

    def update_log(self, text):
        self.txt_log.append(text)

    def on_finished(self):
        self.btn_start.setText(tr("MSG_SUCCESS"))
        self.btn_start.setEnabled(True)
        QMessageBox.information(self, tr("MSG_SUCCESS"), tr("MSG_DOWNLOAD_COMPLETE"))

